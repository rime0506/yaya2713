<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIå¡å“‡ä¼Šåƒç´ å±‹ - é‡æ„ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* ä¿æŒæ‰€æœ‰åŸæœ‰æ ·å¼ï¼Œåªæ·»åŠ æˆ¿é—´é‡æ„éƒ¨åˆ† */
        :root {
            --bg-pink: #ffdef2;
            --main-pink: #ff9ed2;
            --dark-pink: #e06c9f;
            --accent-yellow: #fff3ad;
            --accent-blue: #aedeef;
            --text-color: #75425e;
            --pixel-font: 'Press Start 2P', cursive;
            --grid-size: 32px; /* æ–°å¢ï¼šæ ¼å­å¤§å° */
            
            /* ç¨€æœ‰åº¦é¢œè‰² */
            --r-color: #b0b0b0;
            --sr-color: #ff9ed2;
            --ssr-color: #ffd700;
            
            /* åˆ†ç±»é¢œè‰² */
            --furniture-color: #ff9ed2; /* å®¶å…· */
            --decor-color: #aedeef;     /* æ‘†ä»¶ */
            --wall-color: #fff3ad;      /* å¢™é¥° */
            --floor-color: #c9e4c5;     /* åœ°é¥° */
        }
        
        /* === æˆ¿é—´é‡æ„æ ·å¼ === */
        .room-container-cute {
            width: 352px; /* 11ä¸ªæ ¼å­ */
            height: 320px; /* 10ä¸ªæ ¼å­ */
            background-color: #fff0f5;
            border: 6px solid var(--dark-pink);
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        /* å¢™é¢åŒºåŸŸ - ä¸Šæ–¹2è¡Œ */
        .room-wall-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(var(--grid-size) * 2); /* 2è¡Œé«˜åº¦ */
            background-color: #f8c3cd;
            background-image: 
                linear-gradient(45deg, var(--dark-pink) 25%, transparent 25%, transparent 75%, var(--dark-pink) 75%, var(--dark-pink)),
                linear-gradient(45deg, var(--dark-pink) 25%, transparent 25%, transparent 75%, var(--dark-pink) 75%, var(--dark-pink));
            background-size: 16px 16px;
            background-position: 0 0, 8px 8px;
            border-bottom: 4px solid var(--dark-pink);
            opacity: 0.8;
            z-index: 1;
            box-shadow: 
                0 10px 15px rgba(224, 108, 159, 0.3), /* åº•éƒ¨é˜´å½± */
                inset 0 -4px 8px rgba(0, 0, 0, 0.1); /* å†…éƒ¨é˜´å½±å¢å¼ºç«‹ä½“æ„Ÿ */
        }
        
        /* åœ°é¢åŒºåŸŸ - ä¸‹æ–¹8è¡Œ */
        .room-floor-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(var(--grid-size) * 8); /* 8è¡Œé«˜åº¦ */
            background-color: #f5e6e8;
            z-index: 2;
            box-shadow: 
                inset 0 4px 8px rgba(0, 0, 0, 0.1), /* é¡¶éƒ¨å†…éƒ¨é˜´å½± */
                0 -5px 10px rgba(224, 108, 159, 0.2); /* è¾¹ç¼˜é˜´å½± */
            transform: perspective(500px) rotateX(5deg);
            transform-origin: top center;
        }
        
        /* æ ¼å­ç½‘æ ¼ - è§†è§‰è¾…åŠ© */
        .room-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: var(--grid-size) var(--grid-size);
            background-image: 
                linear-gradient(to right, rgba(224, 108, 159, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(224, 108, 159, 0.1) 1px, transparent 1px);
            pointer-events: none;
            z-index: 3;
        }
        
        /* å·²æ”¾ç½®çš„å®¶å…· - åŸºäºæ ¼å­ */
        .placed-furniture { 
            position: absolute;
            z-index: 10;
            cursor: move;
            touch-action: none;
            transition: transform 0.1s ease;
            transform-origin: center;
            image-rendering: pixelated;
        }
        
        /* å®¶å…·åˆ†ç±»æŒ‡ç¤ºå™¨ */
        .type-indicator {
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .type-furniture { background: var(--furniture-color); }
        .type-decor { background: var(--decor-color); }
        .type-wall { background: var(--wall-color); }
        .type-floor { background: var(--floor-color); }
        
        /* æ”¾ç½®é¢„è§ˆï¼ˆæœ‰æ•ˆä½ç½®ï¼‰ */
        .placement-valid {
            box-shadow: 0 0 0 3px #4CAF50;
        }
        
        /* æ”¾ç½®é¢„è§ˆï¼ˆæ— æ•ˆä½ç½®ï¼‰ */
        .placement-invalid {
            box-shadow: 0 0 0 3px #f44336;
            opacity: 0.7;
        }
        
        /* åˆ†ç±»è¿‡æ»¤å™¨ */
        .type-filter {
            display: flex;
            gap: 5px;
            margin: 10px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        .type-filter-btn {
            padding: 4px 8px;
            font-size: 8px;
            border: 2px solid var(--text-color);
            border-radius: 4px;
            background: var(--accent-yellow);
            color: var(--text-color);
            cursor: pointer;
        }
        .type-filter-btn.active { 
            color: white;
            border-color: var(--dark-pink);
        }
        .type-filter-btn.furniture.active { background: var(--furniture-color); }
        .type-filter-btn.decor.active { background: var(--decor-color); }
        .type-filter-btn.wall.active { background: var(--wall-color); }
        .type-filter-btn.floor.active { background: var(--floor-color); }
        
        /* èƒŒåŒ…åˆ†ç±»æ ‡ç­¾ */
        .category-label {
            width: 100%;
            text-align: left;
            font-size: 10px;
            margin: 15px 0 5px 0;
            color: var(--dark-pink);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .category-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        /* ä¿ç•™åŸæœ‰æ‰€æœ‰å…¶ä»–æ ·å¼ */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            image-rendering: pixelated;
        }
        body {
            font-family: var(--pixel-font);
            background-color: var(--bg-pink);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            background-image: 
                radial-gradient(var(--main-pink) 2px, transparent 2px),
                radial-gradient(var(--main-pink) 2px, transparent 2px);
            background-size: 32px 32px;
            background-position: 0 0, 16px 16px;
        }
        .pixel-box {
            background: #fff;
            border: 4px solid var(--dark-pink);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        #app {
            width: 100%; max-width: 420px; height: 100%; max-height: 800px;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
            background: #fff6fb; border: 4px solid var(--dark-pink);
        }
        header {
            background: var(--main-pink); color: #fff; padding: 12px;
            text-align: center; font-size: 14px; border-bottom: 4px solid var(--dark-pink);
            display: flex; justify-content: space-between; align-items: center;
            text-shadow: 2px 2px 0 var(--dark-pink);
        }
        .coin-display {
            font-size: 10px; background: rgba(0,0,0,0.2); padding: 4px 8px;
            border-radius: 4px; display: flex; align-items: center; gap: 5px;
        }
        .pixel-btn {
            font-family: var(--pixel-font); background: var(--accent-yellow);
            border: 4px solid var(--text-color); box-shadow: 4px 4px 0 var(--text-color);
            color: var(--text-color); padding: 12px 15px; font-size: 12px; cursor: pointer;
            text-align: center; margin: 10px 0; position: relative;
        }
        .pixel-btn:active { top: 2px; left: 2px; box-shadow: 2px 2px 0 var(--text-color); }
        .pixel-btn.pink { background: var(--main-pink); color: white; text-shadow: 2px 2px 0 var(--dark-pink); }
        .pixel-btn.ai { background: linear-gradient(45deg, #aedeef, #ffdef2); animation: gradient 3s infinite; }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .screen { flex: 1; display: none; flex-direction: column; padding: 20px; overflow-y: auto; align-items: center; }
        .screen.active { display: flex; }
        .gacha-machine-cute {
            width: 280px; height: 340px; background: var(--main-pink);
            border: 6px solid var(--dark-pink); border-radius: 30px 30px 10px 10px;
            display: flex; flex-direction: column; align-items: center; padding-top: 20px;
            box-shadow: 8px 8px 0 rgba(224, 108, 159, 0.3); position: relative;
        }
        .machine-window {
            width: 220px; height: 160px; background: var(--accent-blue);
            border: 5px solid var(--dark-pink); border-radius: 50% 50% 10px 10px / 40% 40% 10px 10px;
            position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        .loading-text { font-size: 10px; color: var(--text-color); animation: blink 1s infinite; display: none; text-align: center;}
        @keyframes blink { 50% { opacity: 0.5; } }
        .knob-area { margin-top: 20px; display: flex; gap: 15px; align-items: center; }
        .gacha-knob {
            width: 60px; height: 60px; background: var(--accent-yellow); border: 5px solid var(--dark-pink);
            border-radius: 50%; box-shadow: 4px 4px 0 var(--dark-pink); cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        .gacha-knob:active { transform: rotate(20deg) scale(0.95); }
        
.inventory-bar-cute {
    width: 100%; 
    max-width: 100%; /* ç¡®ä¿ä¸è¶…è¿‡å®¹å™¨å®½åº¦ */
    background: #fff; 
    border: 4px solid var(--dark-pink); 
    padding: 8px;
    display: flex; 
    gap: 8px; 
    overflow-x: auto;  /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
    overflow-y: hidden;
    min-height: 72px; /* å›ºå®šé«˜åº¦ */
    max-height: 72px; /* å›ºå®šé«˜åº¦ */
    flex-wrap: nowrap; /* ç¡®ä¿ä¸æ¢è¡Œ */
    align-items: center;
    scrollbar-width: thin; /* Firefox æ»šåŠ¨æ¡æ ·å¼ */
    scrollbar-color: var(--main-pink) var(--bg-pink);
    /* æ·»åŠ å·¦å³å†…è¾¹è·ï¼Œè®©ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªç‰©å“ä¸è´´è¾¹ */
    padding-left: 12px;
    padding-right: 12px;
    /* é‡è¦ï¼šé™åˆ¶å®¹å™¨çš„å¯è§åŒºåŸŸï¼Œæ¨¡æ‹Ÿ4ä¸ªæ ¼å­çš„å®½åº¦ */
    -webkit-overflow-scrolling: touch; /* iOS å¹³æ»‘æ»šåŠ¨ */
    /* éšè—é»˜è®¤æ»šåŠ¨æ¡ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ */
    scrollbar-width: none; /* Firefox */
}

/* éšè—Webkitæµè§ˆå™¨çš„é»˜è®¤æ»šåŠ¨æ¡ */
.inventory-bar-cute::-webkit-scrollbar {
    display: none;
}

/* æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æŒ‡ç¤ºå™¨ */
#inventory-container::after {
    content: 'â†’';
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--dark-pink);
    font-size: 16px;
    pointer-events: none;
    opacity: 0.7;
    animation: bounce-right 1s infinite alternate;
}

@keyframes bounce-right {
    from { transform: translateY(-50%) translateX(0); }
    to { transform: translateY(-50%) translateX(5px); }
}

/* æ·»åŠ æ‹–åŠ¨æç¤º */
#inventory-container::before {
    content: 'æ‹–åŠ¨æŸ¥çœ‹ â†’';
    position: absolute;
    left: 50%;
    top: -8px;
    transform: translateX(-50%);
    color: var(--dark-pink);
    font-size: 8px;
    background: var(--accent-yellow);
    padding: 2px 6px;
    border-radius: 10px;
    border: 1px solid var(--dark-pink);
    white-space: nowrap;
    z-index: 1;
}

.item-slot-cute {
    min-width: 56px; 
    width: 56px; /* å›ºå®šå®½åº¦ */
    height: 56px; 
    background: var(--bg-pink); 
    border: 3px dashed var(--main-pink);
    border-radius: 8px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    position: relative;
    flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    /* æ·»åŠ ç‚¹å‡»åé¦ˆ */
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.item-slot-cute:hover {
    border-color: var(--dark-pink);
    transform: scale(1.05);
}

/* åˆ†ç±»åˆ†éš”ç¬¦æ ·å¼ */
.category-separator {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    min-width: 40px; /* ç»™åˆ†éš”ç¬¦ä¸€ä¸ªæœ€å°å®½åº¦ */
}
        .item-slot-cute.selected { border: 4px solid var(--accent-yellow); background: #fffce6; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-3px); } }
        .item-count-badge {
            position: absolute; bottom: -5px; right: -5px; background: var(--dark-pink); color: white;
            font-size: 8px; padding: 3px 5px; border-radius: 10px; border: 2px solid white;
        }
        .furniture-icon { width: 40px; height: 40px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2)); }
        /* ç¨€æœ‰åº¦å¾½ç«  */
        .rarity-badge {
            position: absolute; top: -5px; left: -5px; font-size: 8px;
            padding: 2px 5px; border-radius: 10px; border: 2px solid white;
            font-weight: bold; text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }
        .rarity-r { background: var(--r-color); color: white; }
        .rarity-sr { background: var(--sr-color); color: white; }
        .rarity-ssr { background: var(--ssr-color); color: #75425e; }
        
        #toast {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: var(--dark-pink); color: #fff; padding: 12px 20px;
            border: 4px solid #fff; border-radius: 20px; display: none; z-index: 200; font-size: 12px;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; width: 85%; max-width: 350px; padding: 20px; 
            border: 4px solid var(--dark-pink); border-radius: 10px; text-align: center;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-title {
            font-size: 14px; color: var(--dark-pink); margin-bottom: 15px;
        }
        
        /* AIç”Ÿæˆå¼¹çª— */
        .prompt-input {
            width: 100%; padding: 10px; margin: 10px 0; border: 2px solid var(--dark-pink); 
            font-family: inherit; font-size: 10px; border-radius: 4px; resize: vertical; min-height: 60px;
        }
        .prompt-input::placeholder {
            color: #aaa; font-size: 9px;
        }
        .modal-buttons {
            display: flex; gap: 10px; justify-content: center; margin-top: 15px;
        }
        .modal-info {
            font-size: 9px; color: #666; margin: 8px 0;
        }
        
        /* æ‰­è›‹æ± æŸ¥çœ‹ */
        .pool-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin: 15px 0; max-height: 300px; overflow-y: auto; padding: 5px;
        }
        .pool-item {
            background: var(--bg-pink); border: 3px solid var(--main-pink); border-radius: 8px;
            padding: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        .pool-item svg {
            width: 32px; height: 32px; margin-bottom: 3px;
        }
        .pool-item-name {
            font-size: 7px; color: var(--text-color); text-align: center; word-break: break-all;
            max-height: 24px; overflow: hidden;
        }
        .rarity-display {
            font-size: 6px; margin-top: 2px; padding: 1px 3px; border-radius: 3px; font-weight: bold;
        }
        
        /* å›¾é‰´æ ·å¼ */
        .catalog-tabs {
            display: flex; gap: 5px; margin-bottom: 10px; justify-content: center;
        }
        .catalog-tab {
            padding: 5px 10px; font-size: 8px; border: 2px solid var(--dark-pink);
            border-radius: 4px; background: var(--bg-pink); cursor: pointer;
        }
        .catalog-tab.active {
            background: var(--main-pink); color: white;
        }
        .catalog-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin: 10px 0; max-height: 350px; overflow-y: auto; padding: 5px;
        }
        .catalog-item {
            background: var(--bg-pink); border: 3px solid var(--main-pink); border-radius: 8px;
            padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        .catalog-item.owned { border-color: var(--accent-yellow); }
        .catalog-item svg {
            width: 40px; height: 40px; margin-bottom: 5px;
        }
        .catalog-item-name {
            font-size: 8px; color: var(--text-color); text-align: center; margin-bottom: 3px;
        }
        .catalog-stats {
            font-size: 6px; color: #666; margin-top: 2px;
        }
        
        /* è®¾ç½®å¼¹çª— */
        input[type="text"], select {
            width: 100%; padding: 10px; margin: 10px 0; border: 2px solid var(--dark-pink); 
            font-family: inherit; font-size: 10px; border-radius: 4px;
        }
        .error-log {
            margin-top: 15px; font-size: 8px; color: #e74c3c; max-height: 80px; overflow-y: auto; 
            text-align: left; padding: 8px; border: 1px dashed #e74c3c;
        }
        .model-list-container {
            max-height: 150px; overflow-y: auto; margin: 10px 0; 
            border: 2px solid var(--main-pink); border-radius: 4px; padding: 5px;
        }
        .model-item {
            padding: 6px; margin: 3px 0; background: var(--bg-pink); border-radius: 4px; 
            cursor: pointer; font-size: 10px; text-align: left; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .model-item.selected { background: var(--main-pink); color: white; }
        .model-filter {
            display: flex; gap: 8px; margin: 8px 0; justify-content: center; flex-wrap: wrap;
        }
        .filter-btn {
            padding: 4px 8px; font-size: 8px; border: 2px solid var(--text-color);
            border-radius: 4px; background: var(--accent-yellow); color: var(--text-color);
            cursor: pointer;
        }
        .filter-btn.active { background: var(--main-pink); color: white; border-color: var(--dark-pink); }
        
        /* å¯¼èˆªæ  */
        .nav-tabs {
            display: flex; justify-content: space-around; margin-top: 15px;
            border-top: 3px solid var(--dark-pink); padding-top: 10px;
        }
        .nav-tab {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            padding: 5px 15px; border-radius: 8px; transition: all 0.2s;
        }
        .nav-tab.active {
            background: var(--main-pink); color: white;
        }
        .nav-tab-icon {
            font-size: 16px; margin-bottom: 3px;
        }
        .nav-tab-text {
            font-size: 8px;
        }
        
        /* ç”Ÿæˆç»“æœé¢„è§ˆ */
        .preview-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            margin: 15px 0;
        }
        .preview-item {
            background: var(--bg-pink); border: 3px solid var(--main-pink); border-radius: 8px;
            padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .preview-item svg {
            width: 40px; height: 40px; margin-bottom: 5px;
        }
        .preview-item-name {
            font-size: 8px; color: var(--text-color); margin-top: 3px;
        }
        
        /* æ‹–æ‹½æŒ‡ç¤ºå™¨ */
        .drag-indicator {
            position: fixed; 
            width: 64px; height: 64px; 
            background: rgba(255, 255, 255, 0.9); 
            border: 3px solid var(--main-pink);
            border-radius: 12px; 
            z-index: 500; 
            display: none; 
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translate(-50%, -50%);
        }
        .drag-indicator svg {
            width: 44px; height: 44px; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        
        /* ç¨€æœ‰åº¦è¿‡æ»¤å™¨ */
        .rarity-filter {
            display: flex; gap: 5px; margin: 10px 0; justify-content: center; flex-wrap: wrap;
        }
        .rarity-filter-btn {
            padding: 3px 6px; font-size: 7px; border: 2px solid var(--text-color);
            border-radius: 4px; cursor: pointer;
        }
        .rarity-filter-btn.active { color: white; }
        .rarity-filter-btn.r { background: var(--r-color); border-color: var(--r-color); }
        .rarity-filter-btn.sr { background: var(--sr-color); border-color: var(--sr-color); }
        .rarity-filter-btn.ssr { background: var(--ssr-color); border-color: var(--ssr-color); }
        .rarity-filter-btn.all { background: var(--accent-yellow); border-color: var(--text-color); }
        
        /* å®¶å…·æ˜¾ç¤ºåœ¨å¥–æ± çš„æ ‡å¿— */
        .in-pool-badge {
            position: absolute; bottom: -5px; left: -5px; 
            background: var(--accent-blue); color: var(--text-color);
            font-size: 6px; padding: 1px 3px; border-radius: 6px; 
            border: 1px solid var(--dark-pink);
        }
        
/* ä¿®å¤èƒŒåŒ…æ ·å¼ - å›ºå®šæ˜¾ç¤º4ä¸ªæ ¼å­å®½åº¦ï¼Œè¶…å‡ºçš„æ»‘åŠ¨æŸ¥çœ‹ */
#inventory-container {
    width: 100%;
    min-height: 72px; /* å›ºå®šæœ€å°é«˜åº¦ï¼Œä¸èƒŒåŒ…æ¡ä¸€è‡´ */
    margin-bottom: 10px;
    position: relative;
    overflow: hidden; /* éšè—å¤–éƒ¨æ»šåŠ¨ */
}

/* å•ä¸ªå®¶å…·å¯¼å‡ºæŒ‰é’®æ ·å¼ - ä¼˜åŒ–ç‰ˆï¼ˆæ›´å®¹æ˜“ç‚¹å‡»ï¼‰ */
.export-single-btn {
    position: absolute;
    top: 2px; /* æ”¹ä¸ºé¡¶éƒ¨ï¼Œä¸å®¹æ˜“è¢«æ‰‹æŒ‡é®æŒ¡ */
    right: 2px;
    width: 22px; /* å¢å¤§æŒ‰é’®å°ºå¯¸ */
    height: 22px;
    background: var(--accent-blue);
    color: var(--text-color);
    font-size: 10px; /* å¢å¤§å­—ä½“ */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 2px solid white; /* åŠ ç²—è¾¹æ¡†å¢åŠ å¯è§†æ€§ */
    opacity: 0.9;
    transition: all 0.2s ease;
    z-index: 100; /* æé«˜å±‚çº§ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* æ·»åŠ é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
    user-select: none; /* é˜²æ­¢æ–‡æœ¬è¢«é€‰ä¸­ */
    -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
}

/* è§¦æ‘¸å±ä¼˜åŒ– */
.export-single-btn:active,
.export-single-btn.touch-active {
    opacity: 1;
    transform: scale(0.85);
    background: var(--main-pink);
    color: white;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* æ¡Œé¢ç«¯æ‚¬åœæ•ˆæœ */
@media (hover: hover) and (pointer: fine) {
    .export-single-btn:hover {
        opacity: 1;
        transform: scale(1.15);
        background: var(--main-pink);
        color: white;
        box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
}

/* é˜²æ­¢å¯¼å‡ºæŒ‰é’®å¹²æ‰°å…¶ä»–ç‚¹å‡»äº‹ä»¶ */
.item-slot-cute {
    position: relative;
}

/* èƒŒåŒ…æ¨ªå‘æ»šåŠ¨æ¡çš„å¯è§æ€§è°ƒæ•´ */
.inventory-bar-cute::-webkit-scrollbar {
    height: 4px;
    display: block;
}

.inventory-bar-cute::-webkit-scrollbar-track {
    background: var(--bg-pink);
    border-radius: 2px;
}

.inventory-bar-cute::-webkit-scrollbar-thumb {
    background: var(--main-pink);
    border-radius: 2px;
}

</div>
    </style>
    <!-- å®¶å…·å¯¼å‡ºå¼¹çª— -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ› ï¸ å®¶å…·å¯¼å‡º ğŸ› ï¸</div>
            
            <div style="margin-bottom: 15px;">
                <div style="text-align:left; font-size:10px; margin:10px 0 5px 0; color:var(--dark-pink);">
                    å¯¼å‡ºä½ æ‰€æœ‰çš„å®¶å…·:
                </div>
                <div style="font-size:9px; color:#666; margin-bottom:10px;">
                    å°†ä½ ç”Ÿæˆçš„å®¶å…·ï¼ˆåå­—ã€å›¾ç‰‡ã€ç¨€æœ‰åº¦ã€åˆ†ç±»ï¼‰å¯¼å‡ºä¸ºJSONæ–‡ä»¶
                </div>
                
                <div class="pixel-box" style="padding: 10px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size:9px; color:var(--dark-pink); margin-bottom:5px;">
                        å½“å‰å®¶å…·æ•°é‡:
                    </div>
                    <div style="font-size:12px; font-weight:bold; color:var(--main-pink);" id="furniture-count">
                        0
                    </div>
                    <div style="font-size:8px; color:#999; margin-top:5px;">
                        åŒ…æ‹¬æ‰€æœ‰AIç”Ÿæˆçš„å®¶å…·
                    </div>
                </div>
                
                <button class="pixel-btn" onclick="exportFurnitureData()" style="width:100%; margin-bottom:10px; background:var(--accent-blue);">
                    ğŸ“¥ å¯¼å‡ºå®¶å…·æ•°æ®
                </button>
                
                <div style="font-size:8px; color:#666; text-align:center; line-height:1.4;">
                    æ–‡ä»¶: my_pixel_furniture.json<br>
                    åªåŒ…å«å®¶å…·ä¿¡æ¯ï¼Œä¸åŒ…å«èƒŒåŒ…æ•°é‡ã€é‡‘å¸ç­‰
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="closeExportModal()" style="width:100%; background:#ccc;">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>
</head>
<body>
<audio id="sfx-gacha"><source src="https://taira-komori.jpn.org/sound_os/game01/se_maoudamashii_system46.mp3" type="audio/mpeg"></audio>
<audio id="sfx-pop"><source src="https://taira-komori.jpn.org/sound_os/game01/se_maoudamashii_system49.mp3" type="audio/mpeg"> </audio>
<audio id="sfx-success"><source src="https://taira-komori.jpn.org/sound_os/game01/se_maoudamashii_system45.mp3" type="audio/mpeg"> </audio>
<audio id="sfx-drag"><source src="https://taira-komori.jpn.org/sound_os/game01/se_maoudamashii_system42.mp3" type="audio/mpeg"> </audio>

<div id="app">
    <header>
        <div style="font-size:12px;">AI PIXEL ROOM v2</div>
        <div class="coin-display">ğŸŸ¡ <span id="coin-count">0</span></div>
<div style="font-size: 16px; cursor: pointer; display: flex; gap: 10px;">
    <span onclick="openExportModal()" title="å¯¼å‡ºå®¶å…·">ğŸ“¤</span>
    <span onclick="openSettings()" title="è®¾ç½®">âš™ï¸</span>
</div>
    </header>
    
    <div id="toast">æç¤ºä¿¡æ¯</div>
    
    <!-- æ‹–æ‹½æŒ‡ç¤ºå™¨ -->
    <div id="drag-indicator" class="drag-indicator">
        <!-- SVGå†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- AIç”Ÿæˆå¼¹çª— -->
    <div id="ai-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âœ¨ AIé­”æ³•å·¥åŠ âœ¨</div>
            <p class="modal-info">è¾“å…¥ä½ æƒ³ç”Ÿæˆçš„å®¶å…·é£æ ¼ï¼ŒAIå°†åˆ›é€ 10ä¸ªä¸åŒè®¾è®¡ï¼</p>
            
            <textarea id="prompt-input" class="prompt-input" placeholder="ä¾‹å¦‚ï¼šæµ·æ´‹ä¸»é¢˜è“è‰²ç³»å®¶å…·ã€å¯çˆ±ç²‰è‰²çŒ«å’ªå®¶å…·ã€ç§‘å¹»é“¶è‰²å®¶å…·ã€å¤å¤æœ¨è´¨å®¶å…·ã€ç°ä»£ç®€çº¦ç»¿è‰²æ¤ç‰©å®¶å…·..."></textarea>
            
            <div class="modal-info">æ¶ˆè€—ï¼šğŸŸ¡1 | ç”Ÿæˆï¼š10ä¸ªä¸åŒå®¶å…·ï¼ˆéšæœºç¨€æœ‰åº¦ï¼‰ | å°†åŠ å…¥æ‰­è›‹å¥–æ± </div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="closeAIModal()" style="background:#ccc;">å–æ¶ˆ</button>
                <button class="pixel-btn pink" onclick="startBatchGeneration()">ç”Ÿæˆ10ä¸ªå®¶å…·</button>
            </div>
        </div>
    </div>
    
    <!-- åƒç´ å°äººç”Ÿæˆå¼¹çª— -->
    <div id="pixel-character-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ§™â€â™‚ï¸ åƒç´ å°äººç”Ÿæˆå™¨ ğŸ§™â€â™‚ï¸</div>
            <p class="modal-info">è¾“å…¥ä½ æƒ³ç”Ÿæˆçš„åƒç´ å°äººé£æ ¼ï¼ŒAIå°†åˆ›é€ 1ä¸ª128Ã—128åƒç´ çš„åƒç´ å°äººï¼</p>
            
            <textarea id="character-prompt-input" class="prompt-input" placeholder="ä¾‹å¦‚ï¼šå¯çˆ±çš„è“è‰²çŒ«å’ªåƒç´ å°äººã€ç§‘å¹»é£æ ¼æœºå™¨äººåƒç´ å°äººã€å¤å¤éª‘å£«åƒç´ å°äººã€ç²‰è‰²é­”æ³•å°‘å¥³åƒç´ å°äºº..."></textarea>
            
            <div class="modal-info">æ¶ˆè€—ï¼šğŸŸ¡1 | ç”Ÿæˆï¼š1ä¸ª128Ã—128åƒç´ å°äººï¼ˆæ¯ä¸ªåƒç´ 1pxï¼‰ | å°†åŠ å…¥èƒŒåŒ…</div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="closePixelCharacterModal()" style="background:#ccc;">å–æ¶ˆ</button>
                <button class="pixel-btn pink" onclick="generatePixelCharacter()">ç”Ÿæˆåƒç´ å°äºº</button>
            </div>
        </div>
    </div>
    
<!-- è§’è‰²è£…æ‰®å¼¹çª— -->
    <div id="character-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ‘¤ è§’è‰²è£…æ‰®ç³»ç»Ÿ ğŸ‘¤</div>
            
            <div class="modal-info">åˆ›å»ºæˆ–é€‰æ‹©è§’è‰²ï¼ŒAIä¼šæ ¹æ®è§’è‰²äººè®¾ä½¿ç”¨èƒŒåŒ…å®¶å…·å¸ƒç½®æˆ¿é—´</div>
            
            <!-- è§’è‰²åˆ—è¡¨ -->
            <div style="text-align:left; font-size:10px; margin:10px 0 5px 0; color:var(--dark-pink);">
                è§’è‰²åˆ—è¡¨:
            </div>
            <div id="character-list" style="max-height: 100px; overflow-y: auto; margin-bottom: 10px; border: 2px solid var(--main-pink); border-radius: 4px; padding: 5px;">
                <!-- è§’è‰²åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- è§’è‰²åå­—è¾“å…¥ -->
            <div style="text-align:left; font-size:10px; margin:10px 0 5px 0; color:var(--dark-pink);">
                è§’è‰²åå­—:
            </div>
            <input type="text" id="character-name-input" class="prompt-input" placeholder="ä¾‹å¦‚ï¼šå°æ¡ƒ" style="min-height: auto; padding: 8px; margin-bottom: 10px;">
            
            <!-- è§’è‰²äººè®¾è¾“å…¥ -->
            <div style="text-align:left; font-size:10px; margin:10px 0 5px 0; color:var(--dark-pink);">
                è§’è‰²äººè®¾:
            </div>
            <textarea id="character-profile-input" class="prompt-input" placeholder="ä¾‹å¦‚ï¼š16å²ï¼Œå–œæ¬¢ç²‰è‰²å’Œè‰è“ï¼Œæ€§æ ¼æ´»æ³¼å¯çˆ±ï¼Œæ¢¦æƒ³æ‹¥æœ‰ä¸€ä¸ªæ¢¦å¹»çš„å…¬ä¸»æˆ¿é—´..." rows="4"></textarea>
            
            <div class="modal-info">AIå°†æ ¹æ®è§’è‰²æ€§æ ¼ã€å–œå¥½å’ŒèƒŒåŒ…å·²æœ‰å®¶å…·è¿›è¡Œæ™ºèƒ½æˆ¿é—´å¸ƒç½®</div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="closeCharacterModal()" style="background:#ccc;">å–æ¶ˆ</button>
                <button class="pixel-btn" onclick="saveCharacterProfile()" style="background:var(--accent-blue);">ä¿å­˜è§’è‰²</button>
                <button class="pixel-btn pink" onclick="startCharacterDecoration()">å¼€å§‹è£…æ‰®</button>
            </div>
            
            <div id="character-log" class="error-log" style="margin-top:10px; font-size:8px;"></div>
        </div>
    </div>
    
    <!-- æ‰­è›‹æ± æŸ¥çœ‹å¼¹çª— -->
    <div id="pool-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ æ‰­è›‹å¥–æ±  ğŸ</div>
            
            <!-- ç¨€æœ‰åº¦è¿‡æ»¤å™¨ -->
            <div class="rarity-filter">
                <button class="rarity-filter-btn all active" onclick="filterPoolItems('all')">å…¨éƒ¨</button>
                <button class="rarity-filter-btn r" onclick="filterPoolItems('r')">R</button>
                <button class="rarity-filter-btn sr" onclick="filterPoolItems('sr')">SR</button>
                <button class="rarity-filter-btn ssr" onclick="filterPoolItems('ssr')">SSR</button>
            </div>
            
            <div class="modal-info" id="pool-info">å¥–æ± æ€»è®¡: <span id="pool-total">0</span> ä¸ªå®¶å…·</div>
            
            <div id="pool-items" class="pool-grid">
                <!-- å¥–æ± å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <button class="pixel-btn" onclick="closePoolModal()" style="width: 100%; margin-top: 10px;">å…³é—­</button>
        </div>
    </div>
    
    <!-- å›¾é‰´å¼¹çª— -->
    <div id="catalog-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“– å®¶å…·å›¾é‰´ ğŸ“–</div>
            
            <!-- å›¾é‰´æ ‡ç­¾é¡µ -->
            <div class="catalog-tabs">
                <button class="catalog-tab active" onclick="switchCatalogTab('all')">å…¨éƒ¨</button>
                <button class="catalog-tab" onclick="switchCatalogTab('owned')">å·²æ‹¥æœ‰</button>
                <button class="catalog-tab" onclick="switchCatalogTab('missing')">æœªæ‹¥æœ‰</button>
            </div>
            
            <!-- ç¨€æœ‰åº¦è¿‡æ»¤å™¨ -->
            <div class="rarity-filter">
                <button class="rarity-filter-btn all active" onclick="filterCatalogItems('all')">å…¨éƒ¨</button>
                <button class="rarity-filter-btn r" onclick="filterCatalogItems('r')">R</button>
                <button class="rarity-filter-btn sr" onclick="filterCatalogItems('sr')">SR</button>
                <button class="rarity-filter-btn ssr" onclick="filterCatalogItems('ssr')">SSR</button>
            </div>
            
            <div class="modal-info" id="catalog-info">
                æ€»è®¡: <span id="catalog-total">0</span> | 
                å·²æ”¶é›†: <span id="catalog-owned">0</span> | 
                æ”¶é›†ç‡: <span id="catalog-rate">0%</span>
            </div>
            
            <div id="catalog-items" class="catalog-grid">
                <!-- å›¾é‰´å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <button class="pixel-btn" onclick="closeCatalogModal()" style="width: 100%; margin-top: 10px;">å…³é—­</button>
        </div>
    </div>
    
    <!-- ç”Ÿæˆç»“æœé¢„è§ˆå¼¹çª— -->
    <div id="generation-preview" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ‰ ç”ŸæˆæˆåŠŸï¼ğŸ‰</div>
            <div class="modal-info">10ä¸ªæ–°å®¶å…·å·²åŠ å…¥æ‰­è›‹å¥–æ± ï¼Œç¨€æœ‰åº¦éšæœºåˆ†é…</div>
            
            <div id="preview-items" class="preview-grid">
                <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div style="font-size: 9px; margin: 10px 0; color: var(--dark-pink);">
                ç°åœ¨ä½ å¯ä»¥é€šè¿‡æ‰­è›‹æœºæŠ½å–è¿™äº›æ–°å®¶å…·äº†ï¼
            </div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="openPoolModal()">æŸ¥çœ‹å¥–æ± </button>
                <button class="pixel-btn pink" onclick="closePreview()">å¼€å§‹æ‰­è›‹ï¼</button>
            </div>
        </div>
    </div>
    
    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">API è®¾ç½®</div>
            <p class="modal-info">è¾“å…¥ä»»æ„ OpenAPI å…¼å®¹åœ°å€å’Œå¯†é’¥ï¼Œæ‹‰å–æ‰€æœ‰æ¨¡å‹</p>
            
            <input type="text" id="api-url-input" placeholder="API åœ°å€ï¼ˆå¦‚ https://api.deepseek.com/v1ï¼‰" value="https://api.openai.com/v1" />
            <input type="text" id="api-key-input" placeholder="API Keyï¼ˆsk-å¼€å¤´æˆ–è‡ªå®šä¹‰å¯†é’¥ï¼‰" />
            
            <button class="pixel-btn" onclick="fetchModels()" style="width:100%; margin-top:5px;">ğŸ” æ‹‰å–æ‰€æœ‰æ¨¡å‹</button>
            
            <!-- æ¨¡å‹è¿‡æ»¤æŒ‰é’® -->
            <div class="model-filter">
                <button class="filter-btn active" onclick="filterModels('all')">å…¨éƒ¨æ¨¡å‹</button>
                <button class="filter-btn" onclick="filterModels('llm')">è¯­è¨€æ¨¡å‹</button>
                <button class="filter-btn" onclick="filterModels('vision')">è§†è§‰æ¨¡å‹</button>
                <button class="filter-btn" onclick="filterModels('other')">å…¶ä»–æ¨¡å‹</button>
            </div>
            
            <!-- æ¨¡å‹åˆ—è¡¨å±•ç¤ºåŒº -->
            <div style="font-size: 9px; text-align: left; margin: 5px 0; color: var(--dark-pink);">
                å¯ç”¨æ¨¡å‹ï¼ˆç‚¹å‡»é€‰æ‹©ï¼Œå…± <span id="model-count">0</span> ä¸ªï¼‰ï¼š
            </div>
            
            <div class="model-list-container" id="model-list">
                <div class="model-item" style="text-align:center;">æœªæ‹‰å–æ¨¡å‹</div>
            </div>
            
            <input type="hidden" id="selected-model" value="" />
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="testAPI()">æµ‹è¯•è¿æ¥</button>
                <button class="pixel-btn" onclick="saveSettings()">ä¿å­˜</button>
                <button class="pixel-btn" style="background:#ccc;" onclick="closeSettings()">å…³é—­</button>
            </div>
            
            <div class="error-log" id="api-test-log"></div>
        </div>
    </div>
    
    <!-- å®¶å…·æ“ä½œå¼¹çª— -->
    <div id="furniture-control-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">ğŸª‘ å®¶å…·æ“ä½œ</div>
            <div class="modal-info">è°ƒæ•´å®¶å…·çš„å¤§å°å’Œæ—‹è½¬æ–¹å‘</div>
            
            <!-- å½“å‰é€‰ä¸­çš„å®¶å…· -->
            <div id="selected-furniture-display" style="margin: 15px 0; text-align: center;">
                <div style="font-size: 12px; margin-bottom: 10px;">é€‰æ‹©ä¸€ä¸ªå®¶å…·è¿›è¡Œæ“ä½œ</div>
                <div id="furniture-preview" style="width: 80px; height: 80px; margin: 0 auto; display: flex; align-items: center; justify-content: center;"></div>
            </div>
            
            <!-- ç¼©æ”¾æ§åˆ¶ -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: var(--dark-pink); margin-bottom: 10px; text-align: left;">
                    å¤§å°è°ƒæ•´ (${GRID_SIZE}px/æ ¼):
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="pixel-btn" style="font-size: 16px; padding: 4px 12px;" onclick="scaleFurniture(-1, -1)">-</button>
                    <div id="furniture-size-display" style="font-size: 12px;">1 x 1</div>
                    <button class="pixel-btn" style="font-size: 16px; padding: 4px 12px;" onclick="scaleFurniture(1, 1)">+</button>
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                    <button class="pixel-btn" style="font-size: 8px;" onclick="scaleFurniture(-1, 0)">å®½åº¦-</button>
                    <button class="pixel-btn" style="font-size: 8px;" onclick="scaleFurniture(0, -1)">é«˜åº¦-</button>
                    <button class="pixel-btn" style="font-size: 8px;" onclick="scaleFurniture(0, 1)">é«˜åº¦+</button>
                    <button class="pixel-btn" style="font-size: 8px;" onclick="scaleFurniture(1, 0)">å®½åº¦+</button>
                </div>
            </div>
            
            <!-- æ—‹è½¬æ§åˆ¶ -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: var(--dark-pink); margin-bottom: 10px; text-align: left;">
                    æ—‹è½¬æ–¹å‘:
                </div>
                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button class="pixel-btn" style="font-size: 12px; padding: 8px 16px;" onclick="rotateFurniture(-90)">â†</button>
                    <div id="rotation-display" style="font-size: 12px; background: var(--accent-yellow); padding: 8px 16px; border: 2px solid var(--dark-pink); border-radius: 4px;">0Â°</div>
                    <button class="pixel-btn" style="font-size: 12px; padding: 8px 16px;" onclick="rotateFurniture(90)">â†’</button>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="resetFurnitureSize()">é‡ç½®å¤§å°</button>
                <button class="pixel-btn" style="background:#ff6b6b;" onclick="recycleFurniture()">å›æ”¶</button>
                <button class="pixel-btn pink" onclick="applyFurnitureChanges()">åº”ç”¨</button>
                <button class="pixel-btn" style="background:#ccc;" onclick="closeFurnitureControl()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- é¢œè‰²é€‰æ‹©å™¨å¼¹çª— -->
    <div id="color-picker-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="color-modal-title">ğŸ¨ ä¿®æ”¹é¢œè‰²</div>
            <div class="modal-info">é€‰æ‹©ä½ å–œæ¬¢çš„é¢œè‰²å’Œæ ·å¼</div>
            
            <!-- æ ·å¼é€‰æ‹© -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: var(--dark-pink); margin-bottom: 5px; text-align: left;">
                    æ ·å¼é€‰æ‹©:
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                    <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <div style="width: 50px; height: 30px; border: 2px solid var(--dark-pink); background-color: #f8c3cd; margin-bottom: 5px;"></div>
                        <input type="radio" name="style-option" value="solid" checked style="margin: 0;">çº¯è‰²
                    </label>
                    <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <div style="width: 50px; height: 30px; border: 2px solid var(--dark-pink); background-color: #f8c3cd; background-image: linear-gradient(45deg, var(--dark-pink) 25%, transparent 25%, transparent 75%, var(--dark-pink) 75%, var(--dark-pink)), linear-gradient(45deg, var(--dark-pink) 25%, transparent 25%, transparent 75%, var(--dark-pink) 75%, var(--dark-pink)); background-size: 16px 16px; margin-bottom: 5px;"></div>
                        <input type="radio" name="style-option" value="pattern1" style="margin: 0;">èŠ±çº¹1
                    </label>
                    <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <div style="width: 50px; height: 30px; border: 2px solid var(--dark-pink); background-color: #f8c3cd; background-image: linear-gradient(90deg, transparent 33%, var(--dark-pink) 33%, var(--dark-pink) 66%, transparent 66%), linear-gradient(transparent 33%, var(--dark-pink) 33%, var(--dark-pink) 66%, transparent 66%); background-size: 12px 12px; margin-bottom: 5px;"></div>
                        <input type="radio" name="style-option" value="pattern2" style="margin: 0;">èŠ±çº¹2
                    </label>
                </div>
            </div>
            
            <!-- é¢œè‰²è¾“å…¥æ¡† -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: var(--dark-pink); margin-bottom: 5px; text-align: left;">
                    é¢œè‰²ä»£ç  (HEX):
                </div>
                <input type="text" id="color-input" placeholder="#ffffff" style="width: 100%; padding: 10px; border: 2px solid var(--dark-pink); font-family: inherit; font-size: 10px; border-radius: 4px;" />
            </div>
            
            <!-- é¢œè‰²é€‰æ‹©å™¨ -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: var(--dark-pink); margin-bottom: 5px; text-align: left;">
                    é¢œè‰²é€‰æ‹©å™¨:
                </div>
                <input type="color" id="color-picker" style="width: 100%; height: 50px; border: 2px solid var(--dark-pink); border-radius: 4px; cursor: pointer;" />
            </div>
            
            <!-- é¢„è®¾é¢œè‰² -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: var(--dark-pink); margin-bottom: 5px; text-align: left;">
                    é¢„è®¾é¢œè‰²:
                </div>
                <div id="preset-colors" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-top: 10px;">
                    <!-- é¢„è®¾é¢œè‰²å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="pixel-btn" onclick="resetColor()">é‡ç½®é¢œè‰²</button>
                <button class="pixel-btn pink" onclick="applyColor()">åº”ç”¨é¢œè‰²</button>
                <button class="pixel-btn" style="background:#ccc;" onclick="closeColorPicker()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- === ä¸»ç•Œé¢ï¼šæ‰­è›‹ === -->
    <div id="screen-gacha" class="screen active">
        <div class="gacha-machine-cute">
            <div class="machine-window" id="glass-area">
                <div class="loading-text" id="ai-loading">
                    AI æ­£åœ¨ç¼–ç»‡åƒç´ ...<br>Generating...
                </div>
                <div id="capsules-visual">
                    <div style="font-size:30px; margin-top:30px;">ğŸ</div>
                </div>
            </div>
            <div class="knob-area">
                <div style="font-size: 10px; color: var(--dark-pink);">æ™®é€š ğŸŸ¡10</div>
                <button class="gacha-knob" onclick="playNormalGacha()" id="gacha-btn">â­</button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="pixel-box" style="width: 90%; padding: 10px; text-align: center; margin-top: 10px; font-size: 10px;">
            <div>å¥–æ± : <span id="pool-count" style="color: var(--dark-pink);">0</span> å®¶å…·</div>
            <div>æ”¶é›†: <span id="collection-count" style="color: var(--dark-pink);">0/0</span></div>
            <div>æœ€æ–°è·å¾—: <span id="last-gained" style="color: var(--dark-pink);">...</span></div>
        </div>
        
        <!-- AIç”ŸæˆæŒ‰é’® -->
        <button class="pixel-btn ai" style="width: 100%; margin-top:10px;" onclick="openAIModal()">
            âœ¨ AIé­”æ³•å·¥åŠ âœ¨<br>
            <span style="font-size:8px;">æ¶ˆè€— ğŸŸ¡1 | ç”Ÿæˆ10ä¸ªç‹¬å®¶å®¶å…·</span>
        </button>
        
        <!-- åƒç´ å°äººç”ŸæˆæŒ‰é’® -->
        <button class="pixel-btn ai" style="width: 100%; margin-top:10px;" onclick="openPixelCharacterModal()">
            ğŸ§™â€â™‚ï¸ åƒç´ å°äººç”Ÿæˆå™¨ ğŸ§™â€â™‚ï¸<br>
            <span style="font-size:8px;">æ¶ˆè€— ğŸŸ¡1 | ç”Ÿæˆ1ä¸ª128Ã—128åƒç´ å°äºº</span>
        </button>
        
        <!-- å¯¼èˆªæ  -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchScreen('gacha')">
                <div class="nav-tab-icon">ğŸ°</div>
                <div class="nav-tab-text">æ‰­è›‹</div>
            </div>
            <div class="nav-tab" onclick="openPoolModal()">
                <div class="nav-tab-icon">ğŸ</div>
                <div class="nav-tab-text">å¥–æ± </div>
            </div>
            <div class="nav-tab" onclick="openCatalogModal()">
                <div class="nav-tab-icon">ğŸ“–</div>
                <div class="nav-tab-text">å›¾é‰´</div>
            </div>
            <div class="nav-tab" onclick="switchScreen('room')">
                <div class="nav-tab-icon">ğŸ </div>
                <div class="nav-tab-text">æˆ¿é—´</div>
            </div>
        </div>
    </div>
    
<div id="screen-room" class="screen">
    <div style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 5px;">
         <button class="pixel-btn" style="margin:0; padding: 8px; flex: 1;" onclick="switchScreen('gacha')">â¬…ï¸è¿”å›</button>
         <button class="pixel-btn" style="margin:0; padding: 8px; background: #aedeef; flex: 1;" onclick="takeScreenshot()">ğŸ“¸æ‹ç…§</button>
         <button class="pixel-btn" style="margin:0; padding: 8px; background: #ff9ed2; flex: 1; color: white;" onclick="openCharacterModal()">ğŸ‘¤è§’è‰²è£…æ‰®</button>
    </div>
    
    <!-- é‡æ„çš„æˆ¿é—´åŒºåŸŸ -->
    <div class="room-container-cute" id="room-area">
        <div class="room-wall-area" id="wall-area"></div>
        <div class="room-floor-area" id="floor-area"></div>
        <div class="room-grid"></div>
        <!-- å·²æ”¾ç½®çš„å®¶å…·å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- é¢œè‰²ä¿®æ”¹æŒ‰é’® -->
    <div style="width: 100%; display: flex; justify-content: space-between; margin: 10px 0; gap: 5px;">
        <button class="pixel-btn" style="flex: 1; background: var(--wall-color);" onclick="openColorPicker('wall')">ğŸ¨ ä¿®æ”¹å¢™é¢é¢œè‰²</button>
        <button class="pixel-btn" style="flex: 1; background: var(--floor-color);" onclick="openColorPicker('floor')">ğŸ¨ ä¿®æ”¹åœ°æ¿é¢œè‰²</button>
    </div>
        
        <!-- åˆ†ç±»è¿‡æ»¤å™¨ -->
        <div class="type-filter">
            <button class="type-filter-btn all active" onclick="filterInventory('all')">å…¨éƒ¨</button>
            <button class="type-filter-btn furniture" onclick="filterInventory('furniture')">å®¶å…·</button>
            <button class="type-filter-btn decor" onclick="filterInventory('decor')">æ‘†ä»¶</button>
            <button class="type-filter-btn wall" onclick="filterInventory('wall')">å¢™é¥°</button>
            <button class="type-filter-btn floor" onclick="filterInventory('floor')">åœ°é¥°</button>
        </div>
        
        <div style="width:100%; text-align:left; font-size: 10px; margin: 10px 0 5px 0; color: var(--dark-pink);">
            ğŸ’ èƒŒåŒ… (ç‚¹å‡»é€‰ä¸­ï¼Œæ‹–åŠ¨æ”¾ç½®):
        </div>
        
        <!-- èƒŒåŒ… - æ‰€æœ‰ç‰©å“åœ¨ä¸€è¡Œä¸­æ˜¾ç¤º -->
        <div id="inventory-container">
            <!-- èƒŒåŒ…å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<script>
// === å®¶å…·å¯¼å‡ºåŠŸèƒ½ ===

// æ‰“å¼€å¯¼å‡ºå¼¹çª—
function openExportModal() {
    // æ›´æ–°å®¶å…·æ•°é‡æ˜¾ç¤º
    const furnitureCount = Object.keys(state.customItems).length;
    document.getElementById('furniture-count').textContent = furnitureCount;
    
    document.getElementById('export-modal').style.display = 'flex';
}

// å…³é—­å¯¼å‡ºå¼¹çª—
function closeExportModal() {
    document.getElementById('export-modal').style.display = 'none';
}

// å¯¼å‡ºå®¶å…·æ•°æ® - iOS Safari å…¼å®¹ç‰ˆ
function exportFurnitureData() {
    // åˆ›å»ºåªåŒ…å«å®¶å…·ä¿¡æ¯çš„å¯¹è±¡
    const exportData = {
        version: "2.0",
        exportTime: new Date().toISOString(),
        totalFurniture: Object.keys(state.customItems).length,
        furniture: {}
    };
    
    // åªå¯¼å‡ºå®¶å…·ä¿¡æ¯ï¼Œä¸åŒ…å«å…¶ä»–æ¸¸æˆæ•°æ®
    Object.keys(state.customItems).forEach(id => {
        const item = state.customItems[id];
        exportData.furniture[id] = {
            name: item.name,
            svg: item.svg,
            rarity: item.rarity,
            type: item.type,
            width: item.width || 1,
            height: item.height || 1,
            inPool: item.inPool || true
        };
    });
    
    // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
    const jsonStr = JSON.stringify(exportData, null, 2);
    
    // æ·»åŠ æ–‡ä»¶å¤´è¯´æ˜ï¼Œç¡®ä¿ç”¨æˆ·çŸ¥é“è¿™æ˜¯JSONæ ¼å¼
    const fileContent = `=== AIåƒç´ å±‹å®¶å…·å¯¼å‡ºæ–‡ä»¶ ===
æ–‡ä»¶è¯´æ˜ï¼šè¿™æ˜¯æ‚¨çš„AIç”Ÿæˆå®¶å…·æ•°æ®æ–‡ä»¶ï¼Œå†…å®¹æ˜¯æ ‡å‡†çš„JSONæ ¼å¼ã€‚
è™½ç„¶æ–‡ä»¶æ‰©å±•åæ˜¯.txtä»¥ç¡®ä¿iOSè®¾å¤‡å…¼å®¹ï¼Œä½†æ‚¨å¯ä»¥ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨æˆ–JSONå·¥å…·æ‰“å¼€ã€‚

${jsonStr}`;
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥ - ä½¿ç”¨.txtæ‰©å±•åç¡®ä¿iOS Safariå…¼å®¹
    // iOS Safariçœ‹åˆ°.txtæ–‡ä»¶ä¼šæ˜¾ç¤ºå®Œæ•´çš„åˆ†äº«èœå•ï¼ŒåŒ…æ‹¬"å­˜å‚¨åˆ°æ–‡ä»¶"
    const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // ç”ŸæˆåŒ…å«æ—¶é—´æˆ³çš„æ–‡ä»¶å
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
    a.download = `ai_pixel_furniture_${timestamp}.txt`;
    
    // è§¦å‘ä¸‹è½½
    document.body.appendChild(a);
    a.click();
    
    // æ¸…ç†
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`âœ… æˆåŠŸå¯¼å‡º ${exportData.totalFurniture} ä¸ªå®¶å…·åˆ°.txtæ–‡ä»¶`);
        closeExportModal();
    }, 100);
}
// å¯¼å‡ºå•ä¸ªå®¶å…· - iOS Safari å…¼å®¹ç‰ˆ
function exportSingleFurniture(itemId) {
    if (!state.customItems[itemId]) {
        showToast("æ‰¾ä¸åˆ°è¯¥å®¶å…·");
        return;
    }
    
    const item = state.customItems[itemId];
    
    // åˆ›å»ºå•ä¸ªå®¶å…·çš„å¯¼å‡ºæ•°æ®
    const exportData = {
        version: "2.0",
        exportTime: new Date().toISOString(),
        type: "single_furniture",
        furniture: {
            [itemId]: {
                name: item.name,
                svg: item.svg,
                rarity: item.rarity,
                type: item.type,
                width: item.width || 1,
                height: item.height || 1,
                inPool: item.inPool || true
            }
        }
    };
    
    // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
    const jsonStr = JSON.stringify(exportData, null, 2);
    
    // æ·»åŠ æ–‡ä»¶å¤´è¯´æ˜
    const fileContent = `=== AIåƒç´ å±‹å•ä¸ªå®¶å…·å¯¼å‡ºæ–‡ä»¶ ===
å®¶å…·åç§°ï¼š${item.name}
ç¨€æœ‰åº¦ï¼š${item.rarity}
åˆ†ç±»ï¼š${getTypeDisplayName(item.type)}
æ–‡ä»¶è¯´æ˜ï¼šè¿™æ˜¯å•ä¸ªå®¶å…·çš„å¯¼å‡ºæ–‡ä»¶ï¼Œå†…å®¹æ˜¯æ ‡å‡†çš„JSONæ ¼å¼ã€‚
è™½ç„¶æ–‡ä»¶æ‰©å±•åæ˜¯.txtä»¥ç¡®ä¿iOSè®¾å¤‡å…¼å®¹ï¼Œä½†æ‚¨å¯ä»¥ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨æˆ–JSONå·¥å…·æ‰“å¼€ã€‚

${jsonStr}`;
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥ - ä½¿ç”¨.txtæ‰©å±•åç¡®ä¿iOS Safariå…¼å®¹
    const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // ç”Ÿæˆæ–‡ä»¶åï¼Œä½¿ç”¨å®¶å…·åç§°ï¼ˆè¿‡æ»¤æ‰ç‰¹æ®Šå­—ç¬¦ï¼‰
    const safeName = item.name.replace(/[<>:"/\\|?*]/g, '_').substring(0, 30);
    const timestamp = new Date().toISOString().slice(0, 10); // åªå–æ—¥æœŸ
    a.download = `${safeName}_${item.rarity}_${timestamp}.txt`;
    
    // è§¦å‘ä¸‹è½½
    document.body.appendChild(a);
    a.click();
    
    // æ¸…ç†
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`âœ… æˆåŠŸå¯¼å‡º "${item.name}"`);
    }, 100);
}

// ç„¶åï¼Œåœ¨headerä¸­æ·»åŠ ä¸€ä¸ªæ‰“å¼€å¯¼å‡ºå¼¹çª—çš„æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
// æ‰¾åˆ°headeréƒ¨åˆ†ï¼Œåœ¨è®¾ç½®æŒ‰é’®æ—è¾¹æ·»åŠ ï¼š
// <div style="font-size: 16px; cursor: pointer;" onclick="openExportModal()">ğŸ“¤</div>
    // === é‡æ„éƒ¨åˆ†ï¼šæˆ¿é—´æ ¼å­ç³»ç»Ÿ ===
    const GRID_SIZE = 32; // åƒç´ 
    const ROOM_WIDTH = 11; // æ ¼å­æ•°
    const ROOM_HEIGHT = 10; // æ ¼å­æ•°
    const WALL_HEIGHT = 2; // å¢™é¢å 2è¡Œ
    
    // ç‰©å“åˆ†ç±»å®šä¹‰
    const ITEM_TYPES = {
        FURNITURE: 'furniture', // å®¶å…· - å åœ°é¢æ ¼å­
        DECOR: 'decor',         // æ‘†ä»¶ - å¯æ”¾åœ°é¢æˆ–å®¶å…·ä¸Š
        WALL: 'wall',           // å¢™é¥° - åªèƒ½æ”¾å¢™é¢
        FLOOR: 'floor'          // åœ°é¥° - åªèƒ½æ”¾åœ°é¢
    };
    
    // === ç¨€æœ‰åº¦å®šä¹‰ ===
    const RARITY = {
        R: { 
            name: "R", 
            color: "#b0b0b0", 
            class: "rarity-r", 
            weight: 50,
            aiWeight: 20
        },
        SR: { 
            name: "SR", 
            color: "#ff9ed2", 
            class: "rarity-sr", 
            weight: 30,
            aiWeight: 50
        },
        SSR: { 
            name: "SSR", 
            color: "#ffd700", 
            class: "rarity-ssr", 
            weight: 5,
            aiWeight: 30
        }
    };
    
    // æ›´æ–°åŸºç¡€å®¶å…·æ•°æ®ï¼Œæ·»åŠ åˆ†ç±»å’Œå°ºå¯¸ä¿¡æ¯ - æé«˜ç²¾ç»†åº¦
    const DEFAULT_FURNITURE = {
        'bed_01': { 
            name: "è‰è“åºŠ", 
            svg: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="30" width="44" height="20" fill="#FF9ED2" stroke="#75425E" stroke-width="2"/>
                <rect x="12" y="32" width="40" height="16" fill="#FFB8E2"/>
                <!-- åºŠå•èŠ±çº¹ -->
                <rect x="14" y="34" width="4" height="4" fill="#FFFFFF"/>
                <rect x="22" y="34" width="4" height="4" fill="#FFFFFF"/>
                <rect x="30" y="34" width="4" height="4" fill="#FFFFFF"/>
                <rect x="38" y="34" width="4" height="4" fill="#FFFFFF"/>
                <rect x="46" y="34" width="4" height="4" fill="#FFFFFF"/>
                <!-- åºŠå¤´ -->
                <rect x="14" y="24" width="14" height="10" fill="#FFFFFF" stroke="#75425E" stroke-width="2"/>
                <!-- æ•å¤´ -->
                <rect x="16" y="26" width="10" height="6" fill="#AEDEEF" rx="2"/>
                <!-- åºŠå¤´ç»†èŠ‚ -->
                <rect x="16" y="22" width="10" height="2" fill="#E06C9F"/>
            </svg>`,
            rarity: "R",
            inPool: true,
            type: ITEM_TYPES.FURNITURE,
            width: 3,
            height: 2
        },
        'table_01': { 
            name: "åƒç´ æ¡Œ", 
            svg: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <!-- æ¡Œé¢ -->
                <rect x="12" y="32" width="40" height="10" fill="#FFF3AD" stroke="#75425E" stroke-width="2"/>
                <!-- æ¡Œé¢çº¹ç† -->
                <rect x="14" y="34" width="36" height="6" fill="#FFE57F" rx="1"/>
                <rect x="16" y="36" width="32" height="2" fill="#FFFDE7"/>
                <!-- æ¡Œè…¿ -->
                <rect x="16" y="42" width="6" height="14" fill="#8C5E35"/>
                <rect x="20" y="44" width="2" height="12" fill="#6D4C3C"/>
                <rect x="42" y="42" width="6" height="14" fill="#8C5E35"/>
                <rect x="46" y="44" width="2" height="12" fill="#6D4C3C"/>
                <!-- æ¡Œè…¿åº•éƒ¨ -->
                <rect x="15" y="55" width="8" height="2" fill="#5D4037"/>
                <rect x="41" y="55" width="8" height="2" fill="#5D4037"/>
                <!-- æ¡Œé¢è£…é¥° -->
                <circle cx="32" cy="36" r="2" fill="#E06C9F"/>
                <circle cx="38" cy="36" r="2" fill="#AEDEEF"/>
                <circle cx="26" cy="36" r="2" fill="#C9E4C5"/>
            </svg>`,
            rarity: "R",
            inPool: true,
            type: ITEM_TYPES.FURNITURE,
            width: 2,
            height: 2
        },
        'plant_01': { 
            name: "çˆ±å¿ƒè‰", 
            svg: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <!-- èŠ±ç›† -->
                <rect x="24" y="40" width="16" height="16" fill="#E06C9F" stroke="#75425E" stroke-width="2" rx="2"/>
                <!-- èŠ±ç›†çº¹ç† -->
                <rect x="26" y="42" width="12" height="12" fill="#FF9ED2" rx="1"/>
                <rect x="28" y="44" width="8" height="2" fill="#FFFFFF"/>
                <rect x="28" y="48" width="8" height="2" fill="#FFFFFF"/>
                <!-- æ¤ç‰©èŒ -->
                <rect x="31" y="30" width="2" height="10" fill="#8BC34A"/>
                <!-- å¶å­ -->
                <polygon points="30,28 34,28 32,24" fill="#7CB342"/>
                <polygon points="28,32 30,32 29,30" fill="#689F38"/>
                <polygon points="34,32 36,32 35,30" fill="#689F38"/>
                <!-- çˆ±å¿ƒèŠ± -->
                <path d="M32,22 Q34,20 36,22 Q38,24 36,26 Q34,28 32,30 Q30,28 28,26 Q26,24 28,22 Q30,20 32,22" fill="#FF4081"/>
                <!-- èŠ±è•Š -->
                <circle cx="32" cy="24" r="1" fill="#FFD700"/>
                <circle cx="34" cy="26" r="1" fill="#FFD700"/>
                <circle cx="30" cy="26" r="1" fill="#FFD700"/>
            </svg>`,
            rarity: "SR",
            inPool: true,
            type: ITEM_TYPES.DECOR,
            width: 1,
            height: 1
        },
        'painting_01': {
            name: "åƒç´ ç”»",
            svg: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <!-- ç”»æ¡† -->
                <rect x="15" y="15" width="34" height="34" fill="#FFF3AD" stroke="#8C5E35" stroke-width="3" rx="3"/>
                <!-- ç”»æ¡†å†…è¾¹ -->
                <rect x="18" y="18" width="28" height="28" fill="#FFFFFF" rx="2"/>
                <!-- ç”»ä½œèƒŒæ™¯ -->
                <rect x="20" y="20" width="24" height="24" fill="#AEDEEF" rx="1"/>
                <!-- åƒç´ ç”»ï¼šå°å±±å’Œå¤ªé˜³ -->
                <rect x="20" y="36" width="24" height="8" fill="#8BC34A" rx="1"/>
                <!-- å±± -->
                <polygon points="26,36 30,32 34,36" fill="#689F38"/>
                <polygon points="30,36 34,30 38,36" fill="#7CB342"/>
                <!-- å¤ªé˜³ -->
                <circle cx="44" cy="24" r="4" fill="#FFD700"/>
                <!-- é˜³å…‰å°„çº¿ -->
                <rect x="44" y="20" width="1" height="2" fill="#FFD700"/>
                <rect x="44" y="28" width="1" height="2" fill="#FFD700"/>
                <rect x="40" cy="24" y="23" width="2" height="1" fill="#FFD700"/>
                <rect x="48" cy="24" y="23" width="2" height="1" fill="#FFD700"/>
                <!-- äº‘æœµ -->
                <rect x="24" y="26" width="8" height="4" fill="#FFFFFF" rx="2"/>
                <rect x="26" y="24" width="4" height="2" fill="#FFFFFF" rx="1"/>
                <!-- ç”»æ¡†è£…é¥° -->
                <circle cx="20" cy="20" r="1" fill="#E06C9F"/>
                <circle cx="44" cy="20" r="1" fill="#E06C9F"/>
                <circle cx="20" cy="44" r="1" fill="#E06C9F"/>
                <circle cx="44" cy="44" r="1" fill="#E06C9F"/>
            </svg>`,
            rarity: "R",
            inPool: true,
            type: ITEM_TYPES.WALL,
            width: 1,
            height: 1
        },
        'rug_01': {
            name: "æ¯›ç»’åœ°æ¯¯",
            svg: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <!-- åœ°æ¯¯ä¸»ä½“ -->
                <rect x="10" y="10" width="44" height="44" fill="#C9E4C5" stroke="#8C5E35" stroke-width="2" rx="5"/>
                <!-- åœ°æ¯¯çº¹ç† -->
                <rect x="12" y="12" width="40" height="40" fill="#A5D6A7" rx="3"/>
                <!-- ä¸­å¿ƒå›¾æ¡ˆ -->
                <circle cx="32" cy="32" r="12" fill="#FF9ED2" opacity="0.6"/>
                <!-- å›¾æ¡ˆç»†èŠ‚ -->
                <circle cx="32" cy="32" r="8" fill="#FFFFFF" opacity="0.8"/>
                <!-- èŠ±çº¹ -->
                <path d="M32,24 Q36,28 32,32 Q28,36 32,40 Q36,36 40,32 Q36,28 32,24" fill="#E06C9F" opacity="0.5"/>
                <!-- è¾¹è§’è£…é¥° -->
                <rect x="14" y="14" width="4" height="4" fill="#AEDEEF" rx="1"/>
                <rect x="46" y="14" width="4" height="4" fill="#AEDEEF" rx="1"/>
                <rect x="14" y="46" width="4" height="4" fill="#AEDEEF" rx="1"/>
                <rect x="46" y="46" width="4" height="4" fill="#AEDEEF" rx="1"/>
                <!-- æ¯›ç»’æ•ˆæœ -->
                <path d="M10,20 L8,22 L10,24" stroke="#8C5E35" stroke-width="1"/>
                <path d="M54,20 L56,22 L54,24" stroke="#8C5E35" stroke-width="1"/>
                <path d="M10,44 L8,42 L10,40" stroke="#8C5E35" stroke-width="1"/>
                <path d="M54,44 L56,42 L54,40" stroke="#8C5E35" stroke-width="1"/>
            </svg>`,
            rarity: "SR",
            inPool: true,
            type: ITEM_TYPES.FLOOR,
            width: 3,
            height: 2
        }
    };
    
// æ¸¸æˆçŠ¶æ€
    let state = {
        coins: 200,
        inventory: {},
        customItems: {},
        placedItems: [],
        occupiedGrid: {},
        apiKey: "",
        apiUrl: "https://api.openai.com/v1",
        apiModel: "",
        availableModels: [],
        filteredModels: [],
        catalog: {},
        characters: []  // æ–°å¢ï¼šè§’è‰²åˆ—è¡¨
    };
    
    // å…¨å±€å˜é‡
    let selectedId = null;
    let draggingItem = null;
    let currentInventoryFilter = 'all';
    let currentPoolFilter = 'all';
    let currentCatalogTab = 'all';
    let currentCatalogFilter = 'all';
    
    // === æ ¸å¿ƒå‡½æ•°ï¼šæ ¼å­ç³»ç»Ÿ ===
    
    // è·å–æ ¼å­åæ ‡
    function getGridPosition(x, y) {
        return {
            gridX: Math.floor(x / GRID_SIZE),
            gridY: Math.floor(y / GRID_SIZE)
        };
    }
    
    // è·å–åƒç´ åæ ‡
    function getPixelPosition(gridX, gridY) {
        return {
            x: gridX * GRID_SIZE + GRID_SIZE / 2,
            y: gridY * GRID_SIZE + GRID_SIZE / 2
        };
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆåŒºåŸŸå†…
    function isValidPosition(gridX, gridY, itemType, itemWidth = 1, itemHeight = 1) {
        // æ£€æŸ¥è¾¹ç•Œ
        if (gridX < 0 || gridY < 0 || 
            gridX + itemWidth > ROOM_WIDTH || 
            gridY + itemHeight > ROOM_HEIGHT) {
            return false;
        }
        
        // æ£€æŸ¥åˆ†ç±»è§„åˆ™
        if (itemType === ITEM_TYPES.WALL) {
            // å¢™é¥°åªèƒ½æ”¾åœ¨å¢™é¢åŒºåŸŸï¼ˆå‰2è¡Œï¼‰
            if (gridY >= WALL_HEIGHT) return false;
        } else if (itemType === ITEM_TYPES.FURNITURE || itemType === ITEM_TYPES.FLOOR) {
            // å®¶å…·å’Œåœ°é¥°åªèƒ½æ”¾åœ¨åœ°é¢åŒºåŸŸï¼ˆç¬¬2è¡Œä»¥åï¼‰
            if (gridY < WALL_HEIGHT) return false;
        }
        // DECORå¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹
        
        return true;
    }
    
    // æ£€æŸ¥æ ¼å­æ˜¯å¦è¢«å ç”¨
    function isGridOccupied(gridX, gridY, itemType, itemWidth = 1, itemHeight = 1, ignoreItemId = null) {
        for (let dx = 0; dx < itemWidth; dx++) {
            for (let dy = 0; dy < itemHeight; dy++) {
                const cellX = gridX + dx;
                const cellY = gridY + dy;
                const cellKey = `${cellX},${cellY}`;
                
                if (state.occupiedGrid[cellKey]) {
                    const occupyingItem = state.occupiedGrid[cellKey];
                    // å¦‚æœæ˜¯è‡ªå·±ï¼Œè·³è¿‡æ£€æŸ¥
                    if (ignoreItemId && occupyingItem.id === ignoreItemId) continue;
                    
                    // åœ°é¥°å¯ä»¥ä¸å®¶å…·å…±å­˜
                    if (itemType === ITEM_TYPES.FLOOR && occupyingItem.type === ITEM_TYPES.FURNITURE) continue;
                    if (occupyingItem.type === ITEM_TYPES.FLOOR && itemType === ITEM_TYPES.FURNITURE) continue;
                    
                    // æ‘†ä»¶å¯ä»¥æ”¾åœ¨å®¶å…·ä¸Š
                    if (itemType === ITEM_TYPES.DECOR && occupyingItem.type === ITEM_TYPES.FURNITURE) continue;
                    
                    // å…¶ä»–æƒ…å†µéƒ½ç®—å†²çª
                    return true;
                }
            }
        }
        return false;
    }
    
    // æ›´æ–°å ç”¨æ ¼å­
    function updateOccupiedGrid() {
        state.occupiedGrid = {};
        
        state.placedItems.forEach(item => {
            const itemData = state.customItems[item.itemId];
            if (!itemData) return;
            
            for (let dx = 0; dx < itemData.width; dx++) {
                for (let dy = 0; dy < itemData.height; dy++) {
                    const cellX = item.gridX + dx;
                    const cellY = item.gridY + dy;
                    const cellKey = `${cellX},${cellY}`;
                    
                    state.occupiedGrid[cellKey] = {
                        id: item.itemId,
                        type: itemData.type,
                        index: state.placedItems.indexOf(item)
                    };
                }
            }
        });
    }
    
    // å°è¯•æ”¾ç½®ç‰©å“
    function tryPlaceItem(itemId, gridX, gridY) {
        const itemData = state.customItems[itemId];
        if (!itemData) return false;
        
        if (!isValidPosition(gridX, gridY, itemData.type, itemData.width, itemData.height)) {
            return false;
        }
        
        if (isGridOccupied(gridX, gridY, itemData.type, itemData.width, itemData.height)) {
            return false;
        }
        
        return true;
    }
    
    // æ”¾ç½®ç‰©å“åˆ°æˆ¿é—´
    function placeItem(itemId, gridX, gridY) {
        if (!tryPlaceItem(itemId, gridX, gridY)) return false;
        
        const itemData = state.customItems[itemId];
        
        state.placedItems.push({
            itemId: itemId,
            gridX: gridX,
            gridY: gridY,
            width: itemData.width || 1,
            height: itemData.height || 1,
            rotation: 0,
            placedTime: Date.now()
        });
        
        updateOccupiedGrid();
        saveData();
        return true;
    }
    
    // ç§»åŠ¨å·²æ”¾ç½®ç‰©å“
    function movePlacedItem(itemIndex, newGridX, newGridY) {
        const item = state.placedItems[itemIndex];
        const itemData = state.customItems[item.itemId];
        
        if (item.gridX === newGridX && item.gridY === newGridY) return false;
        
        const tempGrid = { ...state.occupiedGrid };
        for (let key in tempGrid) {
            if (tempGrid[key].id === item.itemId && tempGrid[key].index === itemIndex) {
                delete tempGrid[key];
            }
        }
        
        let canPlace = true;
        for (let dx = 0; dx < itemData.width; dx++) {
            for (let dy = 0; dy < itemData.height; dy++) {
                const cellX = newGridX + dx;
                const cellY = newGridY + dy;
                const cellKey = `${cellX},${cellY}`;
                
                if (tempGrid[cellKey]) {
                    const occupyingItem = tempGrid[cellKey];
                    
                    if (itemData.type === ITEM_TYPES.FLOOR && occupyingItem.type === ITEM_TYPES.FURNITURE) continue;
                    if (occupyingItem.type === ITEM_TYPES.FLOOR && itemData.type === ITEM_TYPES.FURNITURE) continue;
                    if (itemData.type === ITEM_TYPES.DECOR && occupyingItem.type === ITEM_TYPES.FURNITURE) continue;
                    
                    canPlace = false;
                    break;
                }
            }
            if (!canPlace) break;
        }
        
        if (!canPlace) return false;
        
        if (!isValidPosition(newGridX, newGridY, itemData.type, itemData.width, itemData.height)) {
            return false;
        }
        
        item.gridX = newGridX;
        item.gridY = newGridY;
        updateOccupiedGrid();
        saveData();
        
        // ç«‹å³æ›´æ–°UI
        setTimeout(() => {
            renderRoom();
            updateUI();
        }, 0);
        
        return true;
    }
    
    // === æ‰­è›‹ç³»ç»Ÿï¼ˆä¿æŒä¸å˜ï¼‰===
    
    // æ ¹æ®æ¦‚ç‡é€‰æ‹©ç¨€æœ‰åº¦
    function getRandomRarity(aiGeneration = false) {
        const weights = aiGeneration ? 
            [RARITY.R.aiWeight, RARITY.SR.aiWeight, RARITY.SSR.aiWeight] :
            [RARITY.R.weight, RARITY.SR.weight, RARITY.SSR.weight];
        
        const totalWeight = weights.reduce((a, b) => a + b, 0);
        let random = Math.random() * totalWeight;
        
        if (random < weights[0]) return "R";
        if (random < weights[0] + weights[1]) return "SR";
        return "SSR";
    }
    
    // æ™®é€šæ‰­è›‹
    function playNormalGacha() {
        if (state.coins < 1) {
            showToast("é‡‘å¸ä¸è¶³ (éœ€1)");
            return;
        }
        
        state.coins -= 1;
        
        document.getElementById('sfx-gacha').play();
        
        const glass = document.getElementById('capsules-visual');
        glass.innerHTML = '<div style="font-size:40px; animation:spin 0.5s infinite">ğŸŒ€</div>';
        
        setTimeout(() => {
            const pool = Object.keys(state.customItems).filter(id => 
                state.customItems[id].inPool === true
            );
            
            if (pool.length === 0) {
                showToast("æ‰­è›‹æ± ä¸ºç©º!");
                state.coins += 10;
                updateUI();
                return;
            }
            
            let totalWeight = 0;
            const weightedPool = [];
            
            pool.forEach(id => {
                const item = state.customItems[id];
                const weight = RARITY[item.rarity].weight;
                totalWeight += weight;
                weightedPool.push({ id, weight, cumulative: 0 });
            });
            
            let cumulative = 0;
            weightedPool.forEach(item => {
                cumulative += item.weight;
                item.cumulative = cumulative;
            });
            
            const random = Math.random() * totalWeight;
            let selectedItem = null;
            
            for (const item of weightedPool) {
                if (random <= item.cumulative) {
                    selectedItem = item;
                    break;
                }
            }
            
            if (!selectedItem) {
                selectedItem = weightedPool[0];
            }
            
            const id = selectedItem.id;
            
            addItem(id);
            showResult(state.customItems[id]);
            
        }, 1000);
    }
    
    // æ·»åŠ å®¶å…·åˆ°èƒŒåŒ…
    function addItem(id) {
        state.inventory[id] = (state.inventory[id] || 0) + 1;
        
        if (state.customItems[id]) {
            if (!state.catalog[id]) {
                state.catalog[id] = {
                    seen: true,
                    owned: true
                };
            } else {
                state.catalog[id].seen = true;
                state.catalog[id].owned = true;
            }
        }
        
        saveData();
        updateUI();
    }
    
    // æ˜¾ç¤ºæ‰­è›‹ç»“æœ
    function showResult(item) {
        const glass = document.getElementById('capsules-visual');
        const rarityObj = RARITY[item.rarity];
        glass.innerHTML = `
            <div style="animation: bounce 0.5s; text-align:center">
                <div style="width:60px; height:60px; margin:0 auto; position:relative;">
                    ${item.svg}
                    <div class="rarity-badge ${rarityObj.class}">${rarityObj.name}</div>
                </div>
                <div style="font-size:10px; margin-top:5px; font-weight:bold">${item.name}</div>
            </div>
        `;
        document.getElementById('last-gained').innerText = `${item.name} (${rarityObj.name})`;
        document.getElementById('sfx-pop').play();
        
        if (item.rarity === 'SSR') {
            showToast(`ğŸ‰ æ­å–œè·å¾—SSRå®¶å…·ï¼ ğŸ‰`);
        } else if (item.rarity === 'SR') {
            showToast(`âœ¨ è·å¾—SRå®¶å…·ï¼ âœ¨`);
        }
    }
    
    // === AIç”Ÿæˆç³»ç»Ÿ ===
    
    // æ‰“å¼€AIç”Ÿæˆå¼¹çª—
    function openAIModal() {
        const selectedModel = document.getElementById('selected-model').value;
        if (!state.apiKey) {
            showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key!");
            openSettings();
            return;
        }
        if (!state.apiUrl) {
            showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API åœ°å€!");
            openSettings();
            return;
        }
        if (!selectedModel) {
            showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é€‰æ‹©æ¨¡å‹!");
            openSettings();
            return;
        }
        if (state.coins < 1) {
            showToast("é‡‘å¸ä¸è¶³ (éœ€1)");
            return;
        }
        
        document.getElementById('ai-modal').style.display = 'flex';
    }
    
    function closeAIModal() {
        document.getElementById('ai-modal').style.display = 'none';
        document.getElementById('prompt-input').value = '';
    }
    
    // æ‰¹é‡ç”Ÿæˆ10ä¸ªå®¶å…· - ä¿®å¤JSONè§£æé—®é¢˜
    async function startBatchGeneration() {
        const prompt = document.getElementById('prompt-input').value.trim();
        if (!prompt) {
            showToast("è¯·è¾“å…¥ç”Ÿæˆæè¿°!");
            return;
        }
        
        if (state.coins < 1) {
            showToast("é‡‘å¸ä¸è¶³ (éœ€1)");
            closeAIModal();
            return;
        }
        
        state.coins -= 1;
        updateUI();
        closeAIModal();
        
        const visual = document.getElementById('capsules-visual');
        const loading = document.getElementById('ai-loading');
        visual.style.display = 'none';
        loading.style.display = 'block';
        
        const selectedModel = document.getElementById('selected-model').value;
        
        try {
            // æ”¹è¿›çš„æç¤ºè¯ï¼Œè¦æ±‚AIè¿”å›æ›´ä¸¥æ ¼çš„JSONæ ¼å¼
            const systemPrompt = `ä½ æ˜¯å¤å¤åƒç´ æ¸¸æˆç¾æœ¯å¸ˆï¼Œä¸“é—¨åˆ›ä½œ16-bitæ—¶ä»£çš„ç²¾è‡´åƒç´ è‰ºæœ¯ã€‚            

 æ ¸å¿ƒè¦æ±‚ï¼šçœŸÂ·åƒç´ é£æ ¼ï¼ˆä¸æ˜¯ç®€å•è‰²å—ï¼ï¼‰
1. åƒç´ ç½‘æ ¼é™åˆ¶ï¼šæ•´ä¸ª64x64ç”»å¸ƒæƒ³è±¡æˆ32x32ä¸ªå°åƒç´ æ ¼å­ï¼ˆæ¯ä¸ªæ ¼å­1x1åƒç´ ï¼‰
2. å°æ ¼å­æ„å›¾ï¼šæ‰€æœ‰ç»†èŠ‚å¿…é¡»ç”¨è¿™äº›å°åƒç´ æ ¼å­æ‹¼å‡ºæ¥ï¼Œä¸èƒ½ç›´æ¥ç”¨å¤§çŸ©å½¢
3. åƒç´ çº§ç»†èŠ‚ï¼šè¦æœ‰ã€Šæ˜Ÿéœ²è°·ç‰©è¯­ã€‹ã€ã€Šæ³°æ‹‰ç‘äºšã€‹é‚£ç§ä¸€ä¸ªåƒç´ ä¸€ä¸ªåƒç´ æ‹¼å‡ºæ¥çš„æ„Ÿè§‰
4. è‰²å½©é™åˆ¶ï¼šæ¯ä¸ªå®¶å…·æœ€å¤šä½¿ç”¨8-12ç§é¢œè‰²ï¼Œä½†è¦é€šè¿‡æ’åˆ—åˆ›é€ ä¸°å¯Œæ„Ÿ

åƒç´ è‰ºæœ¯æŠ€æ³•ï¼š
- æŠ–åŠ¨å¤„ç†ï¼šç”¨æ£‹ç›˜æ ¼åƒç´ åˆ›é€ é¢œè‰²è¿‡æ¸¡
- æŠ—é”¯é½¿ï¼šåœ¨è¾¹ç¼˜ç”¨ä¸­é—´è‰²åƒç´ å¹³æ»‘è¿‡æ¸¡
- è½®å»“çº¿ï¼šç”¨æ·±è‰²åƒç´ å‹¾å‹’è½®å»“ï¼Œä½†ä¸æ˜¯çº¯é»‘è‰²ç²—çº¿
- åƒç´ é›†ç¾¤ï¼šç›¸ä¼¼çš„åƒç´ èšåœ¨ä¸€èµ·å½¢æˆè‰²å—ï¼Œä½†å†…éƒ¨è¦æœ‰å˜åŒ–

è®¾è®¡è§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰ï¼š
2. å¿…é¡»ä½¿ç”¨ï¼šå¤šä¸ªå°çŸ©å½¢/åœ†å½¢æ‹¼åˆï¼Œæ¨¡æ‹Ÿåƒç´ æ ¼å­
3. ç»†èŠ‚å¯†åº¦ï¼šæ¯8x8åƒç´ åŒºåŸŸå†…è‡³å°‘è¦æœ‰2-3ç§é¢œè‰²å˜åŒ–
4. çº¹ç†æ–¹æ³•ï¼šç”¨åƒç´ ç‚¹é˜µæ¨¡æ‹Ÿæœ¨çº¹ã€å¸ƒæ–™ã€é‡‘å±ç­‰æè´¨

è¾“å‡ºè¦æ±‚ï¼š
è¯·ç”Ÿæˆ10ä¸ªå®¶å…·ï¼Œæ¯ä¸ªå¿…é¡»ï¼š
1. ä½¿ç”¨çœŸæ­£çš„åƒç´ æ ¼å­æ‹¼åˆæŠ€æ³•ï¼ˆä¸æ˜¯è‰²å—å¡«å……ï¼‰
2. æœ‰ä¸°å¯Œçš„åƒç´ çº§ç»†èŠ‚ï¼ˆå°æ ¼å­ã€å°ç‚¹é˜µï¼‰
3. åŒ…å«æŠ–åŠ¨ã€æŠ—é”¯é½¿ç­‰åƒç´ è‰ºæœ¯æŠ€å·§
4. æ¯ä¸ªSVGè‡³å°‘æœ‰20-30ä¸ªå…ƒç´ ï¼ˆå°çŸ©å½¢/åœ†å½¢ï¼‰

è®°ä½å…³é”®ï¼š
- æƒ³è±¡ä½ åœ¨ç”¨MS Paintä¸€ä¸ªåƒç´ ä¸€ä¸ªåƒç´ åœ°ç”»
- æ‹’ç»"çŸ¢é‡æ„Ÿ"ï¼Œè¿½æ±‚"åƒç´ æ„Ÿ"
- ç»†èŠ‚ï¼ç»†èŠ‚ï¼è¿˜æ˜¯ç»†èŠ‚ï¼ï¼ˆä½†ä¸æ˜¯å¤æ‚æ¸å˜ï¼Œæ˜¯å°åƒç´ ç‚¹ï¼‰

ç”¨æˆ·ä¸»é¢˜ï¼š${prompt}

ç¤ºä¾‹æ ¼å¼ï¼š
[
  {
    "name": "è‰è“åºŠ",
    "svg": "<svg viewBox=\"0 0 64 64\" xmlns=\"http://www.w3.org/2000/svg\"><rect x=\"10\" y=\"30\" width=\"44\" height=\"20\" fill=\"#FF9ED2\"/></svg>"
  }
]

è¯·åªè¿”å›JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡æœ¬ã€‚`;
            
            const response = await fetch(`${state.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Accept': '*/*'
                },
                body: JSON.stringify({
                    model: selectedModel,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: `ç”Ÿæˆ10ä¸ªåƒç´ å®¶å…·ï¼Œä¸»é¢˜ï¼š${prompt}` }
                    ],
                    temperature: 0.8,
                    max_tokens: 20000
                }),
                mode: 'cors'
            });

            if (!response.ok) {
                const errData = await response.text().catch(() => 'æ— è¯¦æƒ…');
                throw new Error(`APIé”™è¯¯ ${response.status}: ${errData.slice(0, 100)}`);
            }

            const data = await response.json();
            let content = data.choices[0].message.content.trim();
            
            console.log("AIè¿”å›å†…å®¹:", content.slice(0, 500)); // è°ƒè¯•ç”¨
            
            // å°è¯•å¤šç§æ–¹å¼æå–JSON
            let items = [];
            
            // æ–¹æ³•1ï¼šå°è¯•ç›´æ¥è§£æ
            try {
                items = JSON.parse(content);
            } catch (e1) {
                console.log("ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•æ¸…ç†å†…å®¹");
                
                // æ–¹æ³•2ï¼šå°è¯•æå–JSONéƒ¨åˆ†
                const jsonMatch = content.match(/\[\s*{[\s\S]*}\s*\]/);
                if (jsonMatch) {
                    try {
                        items = JSON.parse(jsonMatch[0]);
                    } catch (e2) {
                        // æ–¹æ³•3ï¼šå°è¯•ä¿®å¤å¸¸è§çš„JSONæ ¼å¼é—®é¢˜
                        let fixedJson = jsonMatch[0]
                            .replace(/'/g, '"') // å•å¼•å·è½¬åŒå¼•å·
                            .replace(/,\s*}/g, '}') // ç§»é™¤å°¾éšé€—å·
                            .replace(/,\s*\]/g, ']') // ç§»é™¤æ•°ç»„å°¾éšé€—å·
                            .replace(/\]\s*\[/g, '],[') // ä¿®å¤æ•°ç»„è¿æ¥
                            .replace(/}\s*{/g, '},{'); // ä¿®å¤å¯¹è±¡è¿æ¥
                        
                        try {
                            items = JSON.parse(fixedJson);
                        } catch (e3) {
                            // æ–¹æ³•4ï¼šå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨æ„å»º
                            console.log("è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨æ„å»º");
                            
                            // æŸ¥æ‰¾æ‰€æœ‰ç±»ä¼¼å®¶å…·å¯¹è±¡çš„æ–‡æœ¬
                            const itemRegex = /"name":\s*"([^"]+)",\s*"svg":\s*"([^"]+)"/g;
                            let match;
                            const foundItems = [];
                            
                            while ((match = itemRegex.exec(content)) !== null) {
                                foundItems.push({
                                    name: match[1],
                                    svg: match[2].replace(/\\"/g, '"').replace(/\\n/g, '')
                                });
                            }
                            
                            if (foundItems.length >= 5) { // è‡³å°‘æ‰¾åˆ°5ä¸ªå°±ç®—æˆåŠŸ
                                items = foundItems.slice(0, 10); // å–å‰10ä¸ª
                            } else {
                                throw new Error("æ— æ³•æå–è¶³å¤Ÿçš„å®¶å…·æ•°æ®");
                            }
                        }
                    }
                } else {
                    throw new Error("æ— æ³•ä»å“åº”ä¸­æ‰¾åˆ°JSONæ•°ç»„");
                }
            }
            
            if (!Array.isArray(items)) {
                throw new Error("è¿”å›çš„ä¸æ˜¯æ•°ç»„");
            }
            
            if (items.length < 5) {
                throw new Error(`åªæ‰¾åˆ°äº†${items.length}ä¸ªå®¶å…·ï¼Œéœ€è¦è‡³å°‘5ä¸ª`);
            }
            
            // é™åˆ¶æœ€å¤š10ä¸ª
            if (items.length > 10) {
                items = items.slice(0, 10);
            }
            
            const validItems = items.filter(item => {
                if (!item.name || !item.svg) return false;
                if (typeof item.name !== 'string' || typeof item.svg !== 'string') return false;
                if (item.name.trim() === '' || item.svg.trim() === '') return false;
                if (!item.svg.includes('<svg') || !item.svg.includes('</svg>')) return false;
                return true;
            });
            
            if (validItems.length < 5) {
                throw new Error(`åªæœ‰${validItems.length}ä¸ªæœ‰æ•ˆå®¶å…·ï¼Œéœ€è¦è‡³å°‘5ä¸ª`);
            }
            
            const newItems = {};
            validItems.forEach((item, index) => {
                const newId = 'batch_' + Date.now() + '_' + index;
                const rarity = getRandomRarity(true);
                
                // éšæœºåˆ†é…åˆ†ç±»
                const types = Object.values(ITEM_TYPES);
                const randomType = types[Math.floor(Math.random() * types.length)];
                
                // æ ¹æ®åˆ†ç±»è®¾ç½®é»˜è®¤å°ºå¯¸
                let width = 1, height = 1;
                switch(randomType) {
                    case ITEM_TYPES.FURNITURE:
                        width = Math.random() > 0.5 ? 2 : 3;
                        height = Math.random() > 0.5 ? 2 : 1;
                        break;
                    case ITEM_TYPES.FLOOR:
                        width = Math.random() > 0.5 ? 2 : 3;
                        height = Math.random() > 0.5 ? 2 : 1;
                        break;
                    default:
                        width = 1;
                        height = 1;
                }
                
                // ç¡®ä¿SVGæ ¼å¼æ­£ç¡®
                let svgContent = item.svg;
                if (!svgContent.includes('xmlns="http://www.w3.org/2000/svg"')) {
                    svgContent = svgContent.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!svgContent.includes('viewBox="0 0 64 64"')) {
                    svgContent = svgContent.replace('<svg', '<svg viewBox="0 0 64 64"');
                }
                
                newItems[newId] = {
                    name: item.name,
                    svg: svgContent,
                    rarity: rarity,
                    inPool: true,
                    type: randomType,
                    width: width,
                    height: height,
                    generationTime: Date.now()
                };
                
                state.customItems[newId] = newItems[newId];
                
                if (!state.catalog[newId]) {
                    state.catalog[newId] = {
                        seen: true,
                        owned: false
                    };
                }
            });
            
            saveData();
            showGenerationPreview(newItems);
            document.getElementById('sfx-success').play();
            
        } catch (error) {
            console.error("AIæ‰¹é‡ç”Ÿæˆé”™è¯¯:", error);
            showToast("ç”Ÿæˆå¤±è´¥: " + error.message.slice(0, 30));
            state.coins += 1;
            updateUI();
        } finally {
            loading.style.display = 'none';
            visual.style.display = 'block';
        }
    }
    
    // æ‰“å¼€åƒç´ å°äººç”Ÿæˆå¼¹çª—
    function openPixelCharacterModal() {
        const selectedModel = document.getElementById('selected-model').value;
        if (!state.apiKey) { showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API Key!"); openSettings(); return; }
        if (!state.apiUrl) { showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ API åœ°å€!"); openSettings(); return; }
        if (!selectedModel) { showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é€‰æ‹©æ¨¡å‹!"); openSettings(); return; }
        if (state.coins < 1) { showToast("é‡‘å¸ä¸è¶³ (éœ€1)"); return; }
        document.getElementById('pixel-character-modal').style.display = 'flex';
    }
    
    // å…³é—­åƒç´ å°äººç”Ÿæˆå¼¹çª—
    function closePixelCharacterModal() {
        document.getElementById('pixel-character-modal').style.display = 'none';
        document.getElementById('character-prompt-input').value = '';
    }
    
    // ç”Ÿæˆ128Ã—128åƒç´ å°äºº
    async function generatePixelCharacter() {
        const prompt = document.getElementById('character-prompt-input').value.trim();
        if (!prompt) { showToast("è¯·è¾“å…¥ç”Ÿæˆæè¿°!"); return; }
        if (state.coins < 1) { showToast("é‡‘å¸ä¸è¶³ (éœ€1)"); closePixelCharacterModal(); return; }
        
        state.coins -= 1;
        updateUI();
        closePixelCharacterModal();
        
        const visual = document.getElementById('capsules-visual');
        const loading = document.getElementById('ai-loading');
        visual.style.display = 'none';
        loading.style.display = 'block';
        
        const selectedModel = document.getElementById('selected-model').value;
        
        try {
            // æ”¹è¿›çš„æç¤ºè¯ï¼Œè¦æ±‚ç”Ÿæˆ128Ã—128åƒç´ çš„åƒç´ å°äºº
            const systemPrompt = `ä½ æ˜¯ä¸“ä¸šçš„åƒç´ è‰ºæœ¯è®¾è®¡å¸ˆï¼Œæ“…é•¿åˆ›ä½œ128Ã—128åƒç´ å°ºå¯¸çš„åƒç´ å°äººã€‚
            
            æ ¸å¿ƒè¦æ±‚ï¼š
            1. ç”»å¸ƒå°ºå¯¸ï¼šä¸¥æ ¼128Ã—128åƒç´ ï¼ˆviewBox="0 0 128 128"ï¼‰
            2. åƒç´ ç²¾åº¦ï¼šæ¯ä¸ªåƒç´ æ ¼å¿…é¡»æ˜¯1Ã—1åƒç´ 
            3. åƒç´ é£æ ¼ï¼šä½¿ç”¨çœŸåƒç´ è‰ºæœ¯é£æ ¼ï¼Œç±»ä¼¼8-bitæˆ–16-bitæ¸¸æˆè§’è‰²
            4. è§’è‰²è®¾è®¡ï¼šå®Œæ•´çš„äººç‰©å½¢è±¡ï¼ŒåŒ…æ‹¬èº«ä½“ã€å››è‚¢ã€é¢éƒ¨ç‰¹å¾ç­‰
            5. è‰²å½©ä½¿ç”¨ï¼šåˆç†ä½¿ç”¨é¢œè‰²ï¼Œä¿æŒåƒç´ è‰ºæœ¯çš„ç®€æ´æ€§
            6. ç»†èŠ‚è¡¨ç°ï¼šé€šè¿‡åƒç´ ç‚¹è¡¨ç°è§’è‰²çš„ç‰¹å¾å’Œè¡¨æƒ…
            
            è¾“å‡ºè¦æ±‚ï¼š
            1. åªè¿”å›SVGä»£ç ï¼Œä¸åŒ…å«ä»»ä½•å…¶ä»–æ–‡æœ¬
            2. SVGå¿…é¡»åŒ…å«å®Œæ•´çš„xmlnså±æ€§
            3. å¿…é¡»ä½¿ç”¨viewBox="0 0 128 128"
            4. ä½¿ç”¨<rect>å…ƒç´ ç»˜åˆ¶æ¯ä¸ªåƒç´ ç‚¹
            5. ç¡®ä¿SVGä»£ç å¯ä»¥ç›´æ¥åµŒå…¥HTMLä¸­ä½¿ç”¨
            
            ç¤ºä¾‹æ ¼å¼ï¼š
            <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                <rect x="60" y="40" width="8" height="8" fill="#ff9ed2"/>
                <!-- æ›´å¤šåƒç´ ç‚¹... -->
            </svg>
            
            è¯·æ ¹æ®ç”¨æˆ·çš„æè¿°ç”Ÿæˆä¸€ä¸ªåƒç´ å°äººï¼Œç¡®ä¿ç¬¦åˆæ‰€æœ‰å°ºå¯¸å’Œé£æ ¼è¦æ±‚ã€‚`;
            
            const response = await fetch(`${state.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Accept': '*/*'
                },
                body: JSON.stringify({
                    model: selectedModel,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: `ç”Ÿæˆä¸€ä¸ªåƒç´ å°äººï¼Œä¸»é¢˜ï¼š${prompt}` }
                    ],
                    temperature: 0.8,
                    max_tokens: 20000
                }),
                mode: 'cors'
            });
            
            if (!response.ok) {
                const errData = await response.text().catch(() => 'æ— è¯¦æƒ…');
                throw new Error(`APIé”™è¯¯ ${response.status}: ${errData.slice(0, 100)}`);
            }
            
            const data = await response.json();
            let content = data.choices[0].message.content.trim();
            
            console.log("AIè¿”å›å†…å®¹:", content.slice(0, 500)); // è°ƒè¯•ç”¨
            
            // æå–SVGå†…å®¹
            let svgContent = content;
            
            // å¤„ç†å¯èƒ½çš„ä»£ç å—åŒ…è£¹
            if (svgContent.includes('```svg')) {
                svgContent = svgContent.match(/```svg[\s\S]*?```/)[0].replace('```svg', '').replace('```', '').trim();
            }
            
            // éªŒè¯SVGæ ¼å¼
            if (!svgContent.includes('<svg') || !svgContent.includes('</svg>')) {
                throw new Error("ç”Ÿæˆçš„å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„SVGæ ¼å¼");
            }
            
            // ç¡®ä¿SVGæ ¼å¼æ­£ç¡®
            if (!svgContent.includes('xmlns="http://www.w3.org/2000/svg"')) {
                svgContent = svgContent.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if (!svgContent.includes('viewBox="0 0 128 128"')) {
                svgContent = svgContent.replace('<svg', '<svg viewBox="0 0 128 128"');
            }
            
            // åˆ›å»ºè§’è‰²ç‰©å“
            const newId = 'character_' + Date.now();
            const characterItem = {
                name: prompt.length > 20 ? prompt.substring(0, 20) + '...' : prompt,
                svg: svgContent,
                rarity: getRandomRarity(true),
                inPool: false,
                type: ITEM_TYPES.DECOR,
                width: 3,
                height: 4,
                generationTime: Date.now(),
                isCharacter: true
            };
            
            // æ›´æ–°çŠ¶æ€
            state.customItems[newId] = characterItem;
            state.inventory[newId] = (state.inventory[newId] || 0) + 1;
            state.lastGained = characterItem.name;
            
            // æ›´æ–°å›¾é‰´
            if (!state.catalog[newId]) {
                state.catalog[newId] = {
                    seen: true,
                    owned: true
                };
            } else {
                state.catalog[newId].seen = true;
                state.catalog[newId].owned = true;
            }
            
            saveData();
            updateUI();
            showToast(`æˆåŠŸç”Ÿæˆåƒç´ å°äººï¼š${characterItem.name}!`);
            document.getElementById('sfx-success').play();
            
        } catch (error) {
            console.error("ç”Ÿæˆåƒç´ å°äººå¤±è´¥:", error);
            showToast("ç”Ÿæˆå¤±è´¥: " + error.message.slice(0, 30));
            state.coins += 1; // å¤±è´¥æ—¶è¿”è¿˜é‡‘å¸
            updateUI();
        } finally {
            loading.style.display = 'none';
            visual.style.display = 'block';
        }
    }
    
    // æ˜¾ç¤ºç”Ÿæˆç»“æœé¢„è§ˆ
    function showGenerationPreview(newItems) {
        const previewGrid = document.getElementById('preview-items');
        previewGrid.innerHTML = '';
        
        Object.keys(newItems).forEach(key => {
            const item = newItems[key];
            const rarityObj = RARITY[item.rarity];
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                ${item.svg}
                <div class="preview-item-name">${item.name}</div>
                <div class="rarity-display" style="background:${rarityObj.color}">${rarityObj.name}</div>
            `;
            previewGrid.appendChild(previewItem);
        });
        
        document.getElementById('generation-preview').style.display = 'flex';
    }
    
    function closePreview() {
        document.getElementById('generation-preview').style.display = 'none';
        updateUI();
    }
    
    // === UIæ¸²æŸ“ ===
    
    // æ¸²æŸ“æˆ¿é—´
    function renderRoom() {
        const room = document.getElementById('room-area');
        
        const wallArea = document.getElementById('wall-area');
        const floorArea = document.getElementById('floor-area');
        const grid = room.querySelector('.room-grid');
        
        room.innerHTML = '';
        room.appendChild(wallArea);
        room.appendChild(floorArea);
        room.appendChild(grid);
        
        state.placedItems.forEach((pItem, index) => {
            if (!state.customItems[pItem.itemId]) return;
            const meta = state.customItems[pItem.itemId];
            const rarityObj = RARITY[meta.rarity];
            
            const pixelPos = getPixelPosition(pItem.gridX, pItem.gridY);
            
            const el = document.createElement('div');
            el.className = 'placed-furniture';
            el.style.left = pixelPos.x + 'px';
            el.style.top = pixelPos.y + 'px';
            el.style.width = ((pItem.width || meta.width) * GRID_SIZE) + 'px';
            el.style.height = ((pItem.height || meta.height) * GRID_SIZE) + 'px';
            el.style.transform = `rotate(${pItem.rotation || 0}deg)`;
            el.setAttribute('data-index', index);
            
el.innerHTML = `
    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
        ${meta.svg}
    </div>
`;
            
         el.addEventListener('touchstart', startDragPlaced);
            el.addEventListener('mousedown', startDragPlaced);
            
            // ç‚¹å‡»å®¶å…·æ˜¾ç¤ºæ“ä½œæŒ‰é’®
            el.onclick = (e) => {
                if (!e.target.closest('.placed-furniture')) return;
                if (draggingItem) return;
                
                // è®¾ç½®é€‰ä¸­çš„å®¶å…·å¹¶æ‰“å¼€æ“ä½œæ¨¡æ€æ¡†
                selectedFurnitureIndex = index;
                openFurnitureControl();
            };
            
            room.appendChild(el);
        });
    }
    
    // è·å–åˆ†ç±»ç®€ç§°
    function getTypeShortName(type) {
        switch(type) {
            case ITEM_TYPES.FURNITURE: return 'F';
            case ITEM_TYPES.DECOR: return 'D';
            case ITEM_TYPES.WALL: return 'W';
            case ITEM_TYPES.FLOOR: return 'G';
            default: return '?';
        }
    }
    
    // è·å–åˆ†ç±»é¢œè‰²
    function getTypeColor(type) {
        switch(type) {
            case ITEM_TYPES.FURNITURE: return 'var(--furniture-color)';
            case ITEM_TYPES.DECOR: return 'var(--decor-color)';
            case ITEM_TYPES.WALL: return 'var(--wall-color)';
            case ITEM_TYPES.FLOOR: return 'var(--floor-color)';
            default: return '#ccc';
        }
    }
    
    // è·å–åˆ†ç±»åç§°
    function getTypeDisplayName(type) {
        switch(type) {
            case ITEM_TYPES.FURNITURE: return 'å®¶å…·';
            case ITEM_TYPES.DECOR: return 'æ‘†ä»¶';
            case ITEM_TYPES.WALL: return 'å¢™é¥°';
            case ITEM_TYPES.FLOOR: return 'åœ°é¥°';
            default: return 'æœªçŸ¥';
        }
    }
    
    // è¿‡æ»¤èƒŒåŒ…
    function filterInventory(type) {
        currentInventoryFilter = type;
        
        document.querySelectorAll('.type-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (type === 'all') {
            document.querySelector('.type-filter-btn.all').classList.add('active');
        } else {
            document.querySelector(`.type-filter-btn.${type}`).classList.add('active');
        }
        
        renderInventory();
    }
// æ¸²æŸ“èƒŒåŒ… - ä¿®å¤ï¼šå…¨éƒ¨åˆ†ç±»æ—¶åªæ˜¾ç¤ºä¸€è¡Œ
function renderInventory() {
    const container = document.getElementById('inventory-container');
    container.innerHTML = '';
    
    // è·å–æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç‰©å“
    let allItems = [];
    Object.keys(state.inventory).forEach(id => {
        if (state.inventory[id] > 0 && state.customItems[id]) {
            const item = state.customItems[id];
            // æ ¹æ®è¿‡æ»¤å™¨ç­›é€‰
            if (currentInventoryFilter === 'all' || item.type === currentInventoryFilter) {
                allItems.push({id, count: state.inventory[id]});
            }
        }
    });
    
    if (allItems.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999; font-size:10px;">æš‚æ— ç‰©å“</div>';
        return;
    }
    
    // åˆ›å»ºæ°´å¹³æ»šåŠ¨çš„èƒŒåŒ…æ¡
    const list = document.createElement('div');
    list.className = 'inventory-bar-cute';
    
    // æŒ‰åˆ†ç±»æ·»åŠ æ ‡ç­¾ï¼ˆåªåœ¨å…¨éƒ¨åˆ†ç±»æ—¶æ˜¾ç¤ºåˆ†ç±»æ ‡ç­¾ï¼‰
    if (currentInventoryFilter === 'all') {
        // åˆ†ç»„æ˜¾ç¤º
        const itemsByType = {
            [ITEM_TYPES.FURNITURE]: [],
            [ITEM_TYPES.DECOR]: [],
            [ITEM_TYPES.WALL]: [],
            [ITEM_TYPES.FLOOR]: []
        };
        
        allItems.forEach(({id, count}) => {
            const item = state.customItems[id];
            if (itemsByType[item.type]) {
                itemsByType[item.type].push({id, count});
            }
        });
        
        // æŒ‰åˆ†ç±»é¡ºåºæ·»åŠ ç‰©å“
        Object.entries(itemsByType).forEach(([type, items]) => {
            if (items.length === 0) return;
            
            // æ·»åŠ åˆ†ç±»åˆ†éš”ç¬¦
            const separator = document.createElement('div');
            separator.className = 'category-separator';
            separator.innerHTML = `
                <div style="display: flex; align-items: center; margin: 0 8px; color: ${getTypeColor(type)}; font-size: 8px; white-space: nowrap;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${getTypeColor(type)}; margin-right: 4px;"></span>
                    ${getTypeDisplayName(type)}
                </div>
            `;
            list.appendChild(separator);
            
            // æ·»åŠ è¯¥åˆ†ç±»çš„ç‰©å“
            items.forEach(({id, count}) => {
                const item = state.customItems[id];
                const rarityObj = RARITY[item.rarity];
                
                const div = document.createElement('div');
                div.className = `item-slot-cute ${selectedId === id ? 'selected' : ''}`;
                div.setAttribute('data-item-id', id);
                
// åœ¨èƒŒåŒ…ç‰©å“çš„HTMLä¸­æ·»åŠ å¯¼å‡ºæŒ‰é’®
div.innerHTML = `
    <div class="furniture-icon">${item.svg}</div>
    <div class="rarity-badge ${rarityObj.class}">${rarityObj.name}</div>
    ${item.inPool ? '<div class="in-pool-badge">ğŸ</div>' : ''}
    <div class="item-count-badge">${count}</div>
    <div class="export-single-btn" data-item-id="${id}" title="å¯¼å‡ºè¿™ä¸ªå®¶å…·">
        ğŸ“¤
    </div>
`;

// ç§»é™¤åŸæœ¬çš„onclickå±æ€§ï¼Œæ”¹ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢äº‹ä»¶å†’æ³¡å†²çªï¼‰
const exportBtn = div.querySelector('.export-single-btn');
exportBtn.addEventListener('click', function(e) {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
    e.preventDefault();  // é˜»æ­¢é»˜è®¤è¡Œä¸º
    
    const itemId = this.getAttribute('data-item-id');
    if (itemId && state.customItems[itemId]) {
        // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
        this.style.transform = 'scale(0.8)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 150);
        
        exportSingleFurniture(itemId);
    }
});

// é˜»æ­¢çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶è¢«è§¦å‘ï¼ˆå½“ç‚¹å‡»å¯¼å‡ºæŒ‰é’®æ—¶ï¼‰
exportBtn.addEventListener('touchstart', function(e) {
    e.stopPropagation();
});

exportBtn.addEventListener('mousedown', function(e) {
    e.stopPropagation();
});
                
                div.onclick = (e) => {
                    e.stopPropagation();
                    selectedId = (selectedId === id) ? null : id;
                    renderInventory();
                    showToast(`å·²é€‰ä¸­: ${item.name} (${getTypeDisplayName(item.type)})`);
                };
                
                div.addEventListener('touchstart', startDrag);
                div.addEventListener('mousedown', startDrag);
                
                list.appendChild(div);
            });
        });
    } else {
        // ç‰¹å®šåˆ†ç±»æ—¶ç›´æ¥æ˜¾ç¤ºç‰©å“
        allItems.forEach(({id, count}) => {
            const item = state.customItems[id];
            const rarityObj = RARITY[item.rarity];
            
            const div = document.createElement('div');
            div.className = `item-slot-cute ${selectedId === id ? 'selected' : ''}`;
            div.setAttribute('data-item-id', id);
            div.innerHTML = `
                <div class="furniture-icon">${item.svg}</div>
                <div class="rarity-badge ${rarityObj.class}">${rarityObj.name}</div>
                ${item.inPool ? '<div class="in-pool-badge">ğŸ</div>' : ''}
                <div class="item-count-badge">${count}</div>
            `;
            
            div.onclick = (e) => {
                e.stopPropagation();
                selectedId = (selectedId === id) ? null : id;
                renderInventory();
                showToast(`å·²é€‰ä¸­: ${item.name} (${getTypeDisplayName(item.type)})`);
            };
            
            div.addEventListener('touchstart', startDrag);
            div.addEventListener('mousedown', startDrag);
            
            list.appendChild(div);
        });
    }
    
    container.appendChild(list);
    
    // æ·»åŠ CSSæ ·å¼ç”¨äºåˆ†éš”ç¬¦
    if (!document.querySelector('#separator-style')) {
        const style = document.createElement('style');
        style.id = 'separator-style';
        style.textContent = `
            .category-separator {
                display: flex;
                align-items: center;
                flex-shrink: 0;
            }
        `;
        document.head.appendChild(style);
    }
}
    
    // === æ‹–æ‹½é€»è¾‘ ===
    
    function startDrag(e) {
        if (!selectedId) return;
        if (state.inventory[selectedId] <= 0) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const item = state.customItems[selectedId];
        const dragIndicator = document.getElementById('drag-indicator');
        
        dragIndicator.innerHTML = `
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                ${item.svg}
            </div>
            <div style="position:absolute; bottom:2px; right:2px; background:${getTypeColor(item.type)}; color:white; font-size:8px; padding:1px 3px; border-radius:3px;">
                ${getTypeShortName(item.type)}
            </div>
        `;
        dragIndicator.style.display = 'block';
        
        draggingItem = {
            type: 'inventory',
            id: selectedId,
            startX: e.clientX || e.touches[0].clientX,
            startY: e.clientY || e.touches[0].clientY
        };
        
        updateDragIndicator(e);
        document.getElementById('sfx-drag').play();
    }
    
    function startDragPlaced(e) {
        const index = parseInt(e.target.closest('.placed-furniture').getAttribute('data-index'));
        const pItem = state.placedItems[index];
        const item = state.customItems[pItem.itemId];
        
        e.preventDefault();
        e.stopPropagation();
        
        const dragIndicator = document.getElementById('drag-indicator');
        
        dragIndicator.innerHTML = `
            <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                ${item.svg}
            </div>
            <div style="position:absolute; bottom:2px; right:2px; background:${getTypeColor(item.type)}; color:white; font-size:8px; padding:1px 3px; border-radius:3px;">
                ${getTypeShortName(item.type)}
            </div>
        `;
        dragIndicator.style.display = 'block';
        
        draggingItem = {
            type: 'placed',
            index: index,
            id: pItem.itemId,
            startX: e.clientX || e.touches[0].clientX,
            startY: e.clientY || e.touches[0].clientY,
            originalX: pItem.gridX,
            originalY: pItem.gridY
        };
        
        updateDragIndicator(e);
        document.getElementById('sfx-drag').play();
    }
    
    function updateDragIndicator(e) {
        if (!draggingItem) return;
        
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        if (!clientX || !clientY) return;
        
        const dragIndicator = document.getElementById('drag-indicator');
        dragIndicator.style.left = clientX + 'px';
        dragIndicator.style.top = clientY + 'px';
    }
    
    function handleDrag(e) {
        if (!draggingItem) return;
        
        e.preventDefault();
        updateDragIndicator(e);
        
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        if (!clientX || !clientY) return;
        
        const room = document.getElementById('room-area');
        const rect = room.getBoundingClientRect();
        const dragIndicator = document.getElementById('drag-indicator');
        
        const isInRoom = (
            clientX >= rect.left && 
            clientX <= rect.right && 
            clientY >= rect.top && 
            clientY <= rect.bottom
        );
        
        if (isInRoom) {
            const relativeX = clientX - rect.left;
            const relativeY = clientY - rect.top;
            const gridPos = getGridPosition(relativeX, relativeY);
            
            const itemData = state.customItems[draggingItem.id];
            if (itemData) {
                gridPos.gridX = Math.max(0, Math.min(ROOM_WIDTH - itemData.width, gridPos.gridX - Math.floor(itemData.width/2)));
                gridPos.gridY = Math.max(0, Math.min(ROOM_HEIGHT - itemData.height, gridPos.gridY - Math.floor(itemData.height/2)));
                
                let isValid = false;
                if (draggingItem.type === 'inventory') {
                    isValid = tryPlaceItem(draggingItem.id, gridPos.gridX, gridPos.gridY);
                } else {
                    isValid = !isGridOccupied(gridPos.gridX, gridPos.gridY, itemData.type, itemData.width, itemData.height, draggingItem.id) &&
                              isValidPosition(gridPos.gridX, gridPos.gridY, itemData.type, itemData.width, itemData.height);
                }
                
                if (isValid) {
                    dragIndicator.style.borderColor = '#4CAF50';
                    dragIndicator.style.boxShadow = '0 0 0 3px #4CAF50';
                } else {
                    dragIndicator.style.borderColor = '#f44336';
                    dragIndicator.style.boxShadow = '0 0 0 3px #f44336';
                }
            }
        } else {
            dragIndicator.style.borderColor = 'var(--main-pink)';
            dragIndicator.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        }
    }
    
    function endDrag(e) {
        if (!draggingItem) return;
        
        e.preventDefault();
        const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
        const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
        
        const room = document.getElementById('room-area');
        const rect = room.getBoundingClientRect();
        const dragIndicator = document.getElementById('drag-indicator');
        
        let success = false;
        
        if (clientX && clientY && 
            clientX >= rect.left && clientX <= rect.right && 
            clientY >= rect.top && clientY <= rect.bottom) {
            
            const relativeX = clientX - rect.left;
            const relativeY = clientY - rect.top;
            const gridPos = getGridPosition(relativeX, relativeY);
            
            const itemData = state.customItems[draggingItem.id];
            if (itemData) {
                gridPos.gridX = Math.max(0, Math.min(ROOM_WIDTH - itemData.width, gridPos.gridX - Math.floor(itemData.width/2)));
                gridPos.gridY = Math.max(0, Math.min(ROOM_HEIGHT - itemData.height, gridPos.gridY - Math.floor(itemData.height/2)));
                
                if (draggingItem.type === 'inventory') {
                    if (state.inventory[draggingItem.id] > 0 && tryPlaceItem(draggingItem.id, gridPos.gridX, gridPos.gridY)) {
                        state.placedItems.push({ 
                            itemId: draggingItem.id, 
                            gridX: gridPos.gridX, 
                            gridY: gridPos.gridY,
                            placedTime: Date.now()
                        });
                        state.inventory[draggingItem.id]--;
                        selectedId = null;
                        updateOccupiedGrid();
                        saveData();
                        updateUI();
                        showToast("æ”¾ç½®æˆåŠŸ!");
                        success = true;
                    } else {
                        showToast("æ— æ³•æ”¾ç½®åœ¨æ­¤ä½ç½®");
                    }
                } else {
                    // ç§»åŠ¨å·²æ”¾ç½®çš„ç‰©å“
                    if (movePlacedItem(draggingItem.index, gridPos.gridX, gridPos.gridY)) {
                        updateOccupiedGrid();
                        renderRoom();
                        showToast("ç§»åŠ¨æˆåŠŸ!");
                        success = true;
                    } else {
                        // ç§»åŠ¨å¤±è´¥æ—¶ï¼Œå°†ç‰©å“æ”¾å›åŸå¤„
                        movePlacedItem(draggingItem.index, draggingItem.originalX, draggingItem.originalY);
                        updateOccupiedGrid();
                        renderRoom();
                        showToast("æ— æ³•ç§»åŠ¨åˆ°æ­¤ä½ç½®");
                    }
                }
            }
        } else {
            if (draggingItem.type === 'placed') {
                // å¦‚æœæ‹–åŠ¨åˆ°æˆ¿é—´å¤–ï¼Œæ”¾å›åŸå¤„
                movePlacedItem(draggingItem.index, draggingItem.originalX, draggingItem.originalY);
                updateOccupiedGrid();
                renderRoom();
            }
            showToast("å–æ¶ˆæ”¾ç½®");
        }
        
        draggingItem = null;
        dragIndicator.style.display = 'none';
        dragIndicator.style.borderColor = 'var(--main-pink)';
        dragIndicator.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        
        // å¦‚æœæ²¡æœ‰æˆåŠŸæ”¾ç½®æˆ–ç§»åŠ¨ï¼Œç¡®ä¿UIæ›´æ–°
        if (!success) {
            renderRoom();
            updateUI();
        }
    }
    
    // === å…¶ä»–åŠŸèƒ½ ===
    
    function openPoolModal() {
        document.getElementById('pool-modal').style.display = 'flex';
        renderPoolItems();
    }
    
    function closePoolModal() {
        document.getElementById('pool-modal').style.display = 'none';
    }
    
    function renderPoolItems() {
        const poolGrid = document.getElementById('pool-items');
        const poolInfo = document.getElementById('pool-info');
        const poolTotal = document.getElementById('pool-total');
        
        const allItems = Object.keys(state.customItems).filter(id => 
            state.customItems[id].inPool === true
        );
        
        poolTotal.textContent = allItems.length;
        
        let filteredItems = allItems;
        if (currentPoolFilter !== 'all') {
            filteredItems = allItems.filter(id => {
                return state.customItems[id].rarity === currentPoolFilter;
            });
        }
        
        poolInfo.innerHTML = `å¥–æ± æ€»è®¡: <span style="color:var(--dark-pink)">${allItems.length}</span> ä¸ªå®¶å…· | æ˜¾ç¤º: <span style="color:var(--dark-pink)">${filteredItems.length}</span> ä¸ª`;
        
        poolGrid.innerHTML = '';
        
        filteredItems.forEach(id => {
            const item = state.customItems[id];
            const rarityObj = RARITY[item.rarity];
            const poolItem = document.createElement('div');
            poolItem.className = 'pool-item';
            poolItem.innerHTML = `
                ${item.svg}
                <div class="pool-item-name">${item.name}</div>
                <div class="rarity-display" style="background:${rarityObj.color}">${rarityObj.name}</div>
            `;
            poolGrid.appendChild(poolItem);
        });
        
        if (filteredItems.length === 0) {
            poolGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; font-size:10px; color:#999;">æš‚æ— å®¶å…·</div>';
        }
    }
    
    function filterPoolItems(rarity) {
        currentPoolFilter = rarity;
        
        document.querySelectorAll('.rarity-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.rarity-filter-btn.${rarity}`).classList.add('active');
        
        renderPoolItems();
    }
    
    function openCatalogModal() {
        document.getElementById('catalog-modal').style.display = 'flex';
        renderCatalogItems();
    }
    
    function closeCatalogModal() {
        document.getElementById('catalog-modal').style.display = 'none';
    }
    
    function switchCatalogTab(tab) {
        currentCatalogTab = tab;
        
        document.querySelectorAll('.catalog-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.catalog-tab[onclick="switchCatalogTab('${tab}')"]`).classList.add('active');
        
        renderCatalogItems();
    }
    
    function filterCatalogItems(rarity) {
        currentCatalogFilter = rarity;
        
        document.querySelectorAll('.rarity-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.rarity-filter-btn.${rarity}`).classList.add('active');
        
        renderCatalogItems();
    }
    
    function renderCatalogItems() {
        const catalogGrid = document.getElementById('catalog-items');
        const catalogInfo = document.getElementById('catalog-info');
        
        const allItems = Object.keys(state.customItems);
        const ownedItems = allItems.filter(id => state.catalog[id]?.owned);
        const seenItems = allItems.filter(id => state.catalog[id]?.seen);
        
        const total = allItems.length;
        const owned = ownedItems.length;
        const rate = total > 0 ? Math.round((owned / total) * 100) : 0;
        
        document.getElementById('catalog-total').textContent = total;
        document.getElementById('catalog-owned').textContent = owned;
        document.getElementById('catalog-rate').textContent = `${rate}%`;
        
        let filteredItems = allItems;
        
        if (currentCatalogTab === 'owned') {
            filteredItems = ownedItems;
        } else if (currentCatalogTab === 'missing') {
            filteredItems = allItems.filter(id => !state.catalog[id]?.owned);
        }
        
        if (currentCatalogFilter !== 'all') {
            filteredItems = filteredItems.filter(id => {
                return state.customItems[id].rarity === currentCatalogFilter;
            });
        }
        
        catalogGrid.innerHTML = '';
        
        filteredItems.forEach(id => {
            const item = state.customItems[id];
            const catalogEntry = state.catalog[id];
            const rarityObj = RARITY[item.rarity];
            const isOwned = catalogEntry?.owned || false;
            const isSeen = catalogEntry?.seen || false;
            
            const catalogItem = document.createElement('div');
            catalogItem.className = `catalog-item ${isOwned ? 'owned' : ''}`;
            
            if (!isSeen) {
                catalogItem.innerHTML = `
                    <div style="width:40px; height:40px; background:#eee; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px;">?</div>
                    <div class="catalog-item-name">æœªå‘ç°</div>
                    <div class="catalog-stats">???</div>
                `;
            } else {
                const inPoolBadge = item.inPool ? '<div class="in-pool-badge">ğŸ</div>' : '';
                catalogItem.innerHTML = `
                    ${item.svg}
                    ${inPoolBadge}
                    <div class="catalog-item-name">${item.name}</div>
                    <div class="rarity-display" style="background:${rarityObj.color}">${rarityObj.name}</div>
                    <div class="catalog-stats">æ‹¥æœ‰: ${isOwned ? 'âœ…' : 'âŒ'} | å¥–æ± : ${item.inPool ? 'âœ…' : 'âŒ'}</div>
                `;
            }
            
            catalogGrid.appendChild(catalogItem);
        });
        
        if (filteredItems.length === 0) {
            catalogGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; font-size:10px; color:#999;">æš‚æ— å®¶å…·</div>';
        }
    }
    
    function updateUI() {
        document.getElementById('coin-count').innerText = state.coins;
        
        const poolCount = Object.keys(state.customItems).filter(id => 
            state.customItems[id].inPool === true
        ).length;
        document.getElementById('pool-count').textContent = poolCount;
        
        const ownedCount = Object.keys(state.catalog).filter(id => state.catalog[id]?.owned).length;
        const totalCount = Object.keys(state.customItems).length;
        document.getElementById('collection-count').textContent = `${ownedCount}/${totalCount}`;
        
        renderInventory();
        renderRoom();
    }
    
    function saveData() {
        localStorage.setItem('aiPixelGacha_v8', JSON.stringify(state));
    }
    
function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        if (id === 'gacha') {
            document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
        } else if (id === 'room') {
            document.querySelector('.nav-tab:nth-child(4)').classList.add('active');
        }
        
        selectedId = null;
        updateUI();
    }
    
    // === è§’è‰²è£…æ‰®ç³»ç»Ÿ ===
    
    function openCharacterModal() {
        // æ£€æŸ¥APIè®¾ç½®
        if (!state.apiKey || !state.apiUrl || !state.apiModel) {
            showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API");
            openSettings();
            return;
        }
        
        document.getElementById('character-modal').style.display = 'flex';
        renderCharacterList();
    }
    
    function closeCharacterModal() {
        document.getElementById('character-modal').style.display = 'none';
        document.getElementById('character-profile-input').value = '';
        document.getElementById('character-log').textContent = '';
    }
    
    function renderCharacterList() {
        const characterList = document.getElementById('character-list');
        
        if (state.characters.length === 0) {
            characterList.innerHTML = '<div style="text-align:center; padding:10px; color:#999; font-size:9px;">æš‚æ— è§’è‰²ï¼Œè¯·åˆ›å»ºä¸€ä¸ª</div>';
            return;
        }
        
        characterList.innerHTML = '';
        state.characters.forEach((character, index) => {
            const div = document.createElement('div');
            div.className = 'model-item';
            div.style.padding = '8px';
            div.style.margin = '3px 0';
            div.style.border = '2px solid var(--main-pink)';
            div.style.borderRadius = '4px';
            div.style.cursor = 'pointer';
            
            // æ˜¾ç¤ºè§’è‰²åå‰15ä¸ªå­—ç¬¦
            const name = character.name || `è§’è‰²${index + 1}`;
            const profilePreview = character.profile.length > 30 ? 
                character.profile.substring(0, 30) + '...' : character.profile;
            
            div.innerHTML = `
                <div style="font-weight:bold; color:var(--dark-pink); font-size:9px;">${name}</div>
                <div style="font-size:8px; color:#666; margin-top:2px;">${profilePreview}</div>
            `;
            
            div.onclick = () => {
                document.getElementById('character-profile-input').value = character.profile;
            };
            
            div.ondblclick = () => {
                if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${name}"å—ï¼Ÿ`)) {
                    state.characters.splice(index, 1);
                    saveData();
                    renderCharacterList();
                    showToast("è§’è‰²å·²åˆ é™¤");
                }
            };
            
            characterList.appendChild(div);
        });
    }
    
function saveCharacterProfile() {
        const name = document.getElementById('character-name-input').value.trim();
        const profile = document.getElementById('character-profile-input').value.trim();
        
        if (!name) {
            showToast("è¯·è¾“å…¥è§’è‰²åå­—");
            return;
        }
        
        if (!profile) {
            showToast("è¯·è¾“å…¥è§’è‰²äººè®¾");
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåå­—çš„è§’è‰²
        const existingIndex = state.characters.findIndex(c => c.name === name);
        if (existingIndex >= 0) {
            if (confirm(`å·²å­˜åœ¨åä¸º"${name}"çš„è§’è‰²ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                state.characters[existingIndex] = {
                    name: name,
                    profile: profile,
                    createdTime: Date.now()
                };
            } else {
                return;
            }
        } else {
            // æ·»åŠ åˆ°è§’è‰²åˆ—è¡¨
            state.characters.push({
                name: name,
                profile: profile,
                createdTime: Date.now()
            });
        }
        
        saveData();
        renderCharacterList();
        showToast(`è§’è‰²"${name}"å·²ä¿å­˜`);
        document.getElementById('character-name-input').value = '';
        document.getElementById('character-profile-input').value = '';
    }
    
    async function startCharacterDecoration() {
        const profile = document.getElementById('character-profile-input').value.trim();
        if (!profile) {
            showToast("è¯·è¾“å…¥è§’è‰²äººè®¾");
            return;
        }
        
        // æ£€æŸ¥èƒŒåŒ…æ˜¯å¦æœ‰å®¶å…·
        const availableItems = Object.keys(state.inventory).filter(id => 
            state.inventory[id] > 0 && state.customItems[id]
        );
        
        if (availableItems.length === 0) {
            showToast("èƒŒåŒ…æ²¡æœ‰å¯ç”¨çš„å®¶å…·");
            return;
        }
        
        closeCharacterModal();
        showToast("AIæ­£åœ¨æ ¹æ®è§’è‰²äººè®¾å¸ƒç½®æˆ¿é—´...");
        
        const logEl = document.getElementById('character-log');
        logEl.textContent = "åˆ†æè§’è‰²äººè®¾ä¸­...";
        logEl.style.color = "var(--dark-pink)";
        
        try {
            // 1. è·å–èƒŒåŒ…å®¶å…·ä¿¡æ¯
            const furnitureList = availableItems.map(id => {
                const item = state.customItems[id];
                return `${item.name} (${item.type}, ${item.rarity}, å°ºå¯¸:${item.width}x${item.height})`;
            }).join('\n');
            
            // 2. å‡†å¤‡æˆ¿é—´å¸ƒå±€ä¿¡æ¯
            const roomInfo = `æˆ¿é—´å°ºå¯¸: ${ROOM_WIDTH}x${ROOM_HEIGHT} æ ¼å­ï¼Œå¢™é¢åŒºåŸŸ: ä¸Šæ–¹2è¡Œï¼Œåœ°é¢åŒºåŸŸ: ä¸‹æ–¹8è¡Œ`;
            
 // 3. è°ƒç”¨AIåˆ†æå¹¶å¸ƒç½® - æ”¹è¿›ç‰ˆ
            // æ„å»ºå®¶å…·æ˜ å°„è¡¨ï¼Œè®©AIæ›´å®¹æ˜“ç†è§£
            const furnitureMap = {};
            availableItems.forEach(id => {
                const item = state.customItems[id];
                furnitureMap[item.name] = {
                    id: id,
                    type: item.type,
                    width: item.width,
                    height: item.height
                };
            });
            
            const response = await fetch(`${state.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`
                },
                body: JSON.stringify({
                    model: state.apiModel,
                    messages: [
                        {
                            role: "system",
                            content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¤å†…è®¾è®¡å¸ˆã€‚è¯·æ ¹æ®è§’è‰²äººè®¾å’Œå¯ç”¨å®¶å…·ï¼Œä¸ºè§’è‰²å¸ƒç½®ä¸€ä¸ªç¬¦åˆå…¶æ€§æ ¼çš„æˆ¿é—´ã€‚
                            
æˆ¿é—´ä¿¡æ¯ï¼š
- å°ºå¯¸ï¼š11x10æ ¼å­ï¼ˆ11åˆ—å®½ï¼Œ10è¡Œé«˜ï¼‰
- å¢™é¢åŒºåŸŸï¼šç¬¬0-1è¡Œï¼ˆåªèƒ½æ”¾å¢™é¥°ï¼‰
- åœ°é¢åŒºåŸŸï¼šç¬¬2-9è¡Œï¼ˆå®¶å…·å’Œåœ°é¥°åªèƒ½æ”¾åœ¨è¿™é‡Œï¼‰
- æ‘†ä»¶å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ï¼ŒåŒ…æ‹¬å®¶å…·ä¸Š

å¯ç”¨å®¶å…·åˆ—è¡¨ï¼ˆå®¶å…·å -> è¯¦ç»†ä¿¡æ¯ï¼‰ï¼š
${JSON.stringify(furnitureMap, null, 2)}

é‡è¦è§„åˆ™ï¼š
1. å¢™é¥°ï¼ˆwallç±»å‹ï¼‰åªèƒ½æ”¾åœ¨å¢™é¢åŒºåŸŸï¼ˆgridY: 0æˆ–1ï¼‰
2. å®¶å…·ï¼ˆfurnitureç±»å‹ï¼‰å’Œåœ°é¥°ï¼ˆfloorç±»å‹ï¼‰åªèƒ½æ”¾åœ¨åœ°é¢åŒºåŸŸï¼ˆgridY: 2-9ï¼‰
3. æ‘†ä»¶ï¼ˆdecorç±»å‹ï¼‰å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹
4. å®¶å…·ä¸èƒ½é‡å æ”¾ç½®
5. æ¯ä¸ªå®¶å…·éƒ½æœ‰å°ºå¯¸ï¼ˆwidth x heightï¼‰ï¼Œæ”¾ç½®æ—¶éœ€è¦è€ƒè™‘å…¶å¤§å°

ä½ å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ ¼å¼å¿…é¡»ä¸¥æ ¼å¦‚ä¸‹ï¼š
[
  {
    "itemName": "å®¶å…·åç§°ï¼ˆå¿…é¡»ä¸ä¸Šé¢å¯ç”¨å®¶å…·åˆ—è¡¨ä¸­çš„åç§°å®Œå…¨åŒ¹é…ï¼‰",
    "gridX": æ•°å­—ï¼ˆ0-10ä¹‹é—´çš„æ•´æ•°ï¼‰,
    "gridY": æ•°å­—ï¼ˆ0-9ä¹‹é—´çš„æ•´æ•°ï¼‰,
    "reason": "æ”¾ç½®ç†ç”±ï¼ˆä¾‹å¦‚ï¼šå› ä¸ºè¿™ä¸ªä½ç½®é è¿‘çª—æˆ·ï¼Œç¬¦åˆè§’è‰²å–œæ¬¢é˜³å…‰çš„æ€§æ ¼ï¼‰"
  }
]

æ”¾ç½®ç­–ç•¥å»ºè®®ï¼š
1. å¤§ä»¶å®¶å…·ï¼ˆåºŠã€æ¡Œå­ï¼‰é€šå¸¸é å¢™æ”¾ç½®
2. å°ä»¶æ‘†ä»¶å¯ä»¥æ”¾åœ¨å®¶å…·ä¸Šæˆ–æ—è¾¹
3. å¢™é¥°æ”¾åœ¨å¢™é¢æ˜¾çœ¼ä½ç½®
4. åœ°é¥°é“ºåœ¨æˆ¿é—´ä¸­å¤®æˆ–å®¶å…·ä¸‹æ–¹

è§’è‰²äººè®¾ï¼š
${profile}

è¯·åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡æœ¬ã€‚ç¤ºä¾‹ï¼š
[
  {"itemName": "è‰è“åºŠ", "gridX": 1, "gridY": 3, "reason": "æ”¾åœ¨æˆ¿é—´å·¦ä¾§ï¼Œé è¿‘çª—æˆ·ï¼Œæ—©ä¸Šå¯ä»¥æœ‰é˜³å…‰"},
  {"itemName": "åƒç´ æ¡Œ", "gridX": 5, "gridY": 4, "reason": "æ”¾åœ¨æˆ¿é—´ä¸­å¤®ï¼Œæ–¹ä¾¿è§’è‰²ä½¿ç”¨"}
]`
                        },
                        {
                            role: "user",
                            content: `è¯·ä¸ºè¿™ä¸ªè§’è‰²å¸ƒç½®æˆ¿é—´ï¼Œä½¿ç”¨ä¸Šè¿°å¯ç”¨å®¶å…·ã€‚è¯·ç¡®ä¿è¿”å›æ ¼å¼æ˜¯ä¸¥æ ¼çš„JSONæ•°ç»„ã€‚`
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 20000,
                    response_format: { type: "json_object" }  // å¼ºåˆ¶è¿”å›JSONæ ¼å¼
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIé”™è¯¯: ${response.status}`);
            }
            
const data = await response.json();
            let content = data.choices[0].message.content.trim();
            
            logEl.textContent = "æ­£åœ¨è§£æAIå¸ƒç½®æ–¹æ¡ˆ...";
            
            // è§£æAIè¿”å›çš„å¸ƒç½®æ–¹æ¡ˆ
            let placements = [];
            let rawPlacements = null;
            
            try {
                // é¦–å…ˆå°è¯•ç›´æ¥è§£æ
                rawPlacements = JSON.parse(content);
            } catch (e1) {
                logEl.textContent = "ç¬¬ä¸€æ¬¡è§£æå¤±è´¥ï¼Œå°è¯•æå–JSON...";
                try {
                    // å°è¯•æå–JSONæ•°ç»„éƒ¨åˆ†
                    const jsonMatch = content.match(/\[\s*{[\s\S]*}\s*\]/);
                    if (jsonMatch) {
                        rawPlacements = JSON.parse(jsonMatch[0]);
                    } else {
                        // å°è¯•æå–JSONå¯¹è±¡
                        const objectMatch = content.match(/\{[\s\S]*\}/);
                        if (objectMatch) {
                            const obj = JSON.parse(objectMatch[0]);
                            // æ£€æŸ¥å¯¹è±¡ä¸­æ˜¯å¦æœ‰placementsæˆ–itemså­—æ®µ
                            if (obj.placements && Array.isArray(obj.placements)) {
                                rawPlacements = obj.placements;
                            } else if (obj.items && Array.isArray(obj.items)) {
                                rawPlacements = obj.items;
                            } else {
                                // å¦‚æœå¯¹è±¡æœ¬èº«æ˜¯æ•°ç»„å½¢å¼
                                const keys = Object.keys(obj);
                                if (keys.length > 0 && Array.isArray(obj[keys[0]])) {
                                    rawPlacements = obj[keys[0]];
                                }
                            }
                        }
                    }
                } catch (e2) {
                    logEl.textContent = "JSONæå–å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨è§£æ...";
                    // æœ€åå°è¯•ï¼šæ‰‹åŠ¨è§£ææ–‡æœ¬
                    const lines = content.split('\n');
                    const parsedItems = [];
                    
                    for (const line of lines) {
                        if (line.includes('itemName') && line.includes('gridX') && line.includes('gridY')) {
                            try {
                                // å°è¯•ä»æ–‡æœ¬ä¸­æå–JSONå¯¹è±¡
                                const itemMatch = line.match(/\{[^}]*\}/);
                                if (itemMatch) {
                                    const itemStr = itemMatch[0]
                                        .replace(/'/g, '"')
                                        .replace(/,(\s*[}\]])/g, '$1');
                                    const item = JSON.parse(itemStr);
                                    if (item.itemName && typeof item.gridX === 'number' && typeof item.gridY === 'number') {
                                        parsedItems.push(item);
                                    }
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                    
                    if (parsedItems.length > 0) {
                        rawPlacements = parsedItems;
                    } else {
                        throw new Error("æ— æ³•è§£æAIè¿”å›çš„å¸ƒç½®æ–¹æ¡ˆ");
                    }
                }
            }
            
            // ç¡®ä¿rawPlacementsæ˜¯æ•°ç»„
            if (!rawPlacements || !Array.isArray(rawPlacements)) {
                // å¦‚æœrawPlacementsæ˜¯å¯¹è±¡ï¼Œå°è¯•è½¬æ¢ä¸ºæ•°ç»„
                if (rawPlacements && typeof rawPlacements === 'object') {
                    const arr = [];
                    for (const key in rawPlacements) {
                        if (rawPlacements[key] && typeof rawPlacements[key] === 'object') {
                            arr.push(rawPlacements[key]);
                        }
                    }
                    rawPlacements = arr;
                }
            }
            
            if (!Array.isArray(rawPlacements) || rawPlacements.length === 0) {
                throw new Error("AIæ²¡æœ‰è¿”å›æœ‰æ•ˆçš„å¸ƒç½®æ–¹æ¡ˆæ•°ç»„");
            }
            
            placements = rawPlacements;
            
            // 3. æ¸…ç©ºå½“å‰æˆ¿é—´
            state.placedItems = [];
            updateOccupiedGrid();
            
            // 4. å°è¯•æŒ‰ç…§AIçš„æ–¹æ¡ˆæ”¾ç½®å®¶å…·
            let successCount = 0;
            const failedItems = [];
            
            for (const placement of placements) {
                // æ”¯æŒä¸åŒçš„å­—æ®µå
                const itemName = placement.itemName || placement.name || placement.itemId;
                const gridX = placement.gridX || placement.x || 0;
                const gridY = placement.gridY || placement.y || 0;
                const reason = placement.reason || placement.description || "AIå»ºè®®çš„å¸ƒå±€";
                
                if (!itemName || typeof gridX !== 'number' || typeof gridY !== 'number') {
                    failedItems.push(`${itemName || 'æœªçŸ¥å®¶å…·'} (æ•°æ®æ ¼å¼é”™è¯¯)`);
                    continue;
                }
                
                // æŸ¥æ‰¾åŒ¹é…çš„å®¶å…·ï¼ˆæ ¹æ®åç§°ï¼‰
                const matchedItemId = findItemIdByName(itemName);
                
                if (!matchedItemId) {
                    failedItems.push(`${itemName} (æœªæ‰¾åˆ°åŒ¹é…å®¶å…·)`);
                    continue;
                }
                
                // æ£€æŸ¥åº“å­˜
                if (!state.inventory[matchedItemId] || state.inventory[matchedItemId] <= 0) {
                    failedItems.push(`${itemName} (åº“å­˜ä¸è¶³)`);
                    continue;
                }
                
                // å°è¯•æ”¾ç½®
                if (tryPlaceItem(matchedItemId, gridX, gridY)) {
                    state.placedItems.push({
                        itemId: matchedItemId,
                        gridX: gridX,
                        gridY: gridY,
                        placedTime: Date.now(),
                        aiReason: reason
                    });
                    state.inventory[matchedItemId]--;
                    successCount++;
                } else {
                    failedItems.push(`${itemName} (æ— æ³•æ”¾ç½®åœ¨${gridX},${gridY})`);
                }
            }
            
            // æ›´æ–°å ç”¨ç½‘æ ¼
            updateOccupiedGrid();
            saveData();
            
            // æ˜¾ç¤ºç»“æœ
            renderRoom();
            updateUI();
            
            let resultMsg = `AIå¸ƒç½®å®Œæˆï¼æˆåŠŸæ”¾ç½® ${successCount} ä¸ªå®¶å…·`;
            if (failedItems.length > 0) {
                resultMsg += `ï¼Œ${failedItems.length} ä¸ªå¤±è´¥`;
                logEl.textContent = `å¤±è´¥: ${failedItems.join(', ')}`;
                logEl.style.color = "#e74c3c";
            } else {
                logEl.textContent = "æ‰€æœ‰å®¶å…·éƒ½æˆåŠŸæ”¾ç½®ï¼";
                logEl.style.color = "#2ecc71";
            }
            
            showToast(resultMsg);
            
        } catch (error) {
            console.error("è§’è‰²è£…æ‰®é”™è¯¯:", error);
            logEl.textContent = `é”™è¯¯: ${error.message}`;
            logEl.style.color = "#e74c3c";
            showToast("è£…æ‰®å¤±è´¥: " + error.message.slice(0, 30));
        }
    }
    
// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®åç§°æŸ¥æ‰¾å®¶å…·ID - å¢å¼ºç‰ˆ
    function findItemIdByName(name) {
        if (!name || typeof name !== 'string') return null;
        
        const searchName = name.trim().toLowerCase();
        
        // 1. å°è¯•ç²¾ç¡®åŒ¹é…
        for (const id in state.customItems) {
            const item = state.customItems[id];
            if (item.name.toLowerCase() === searchName) {
                return id;
            }
        }
        
        // 2. å°è¯•åŒ…å«åŒ¹é…
        for (const id in state.customItems) {
            const item = state.customItems[id];
            if (item.name.toLowerCase().includes(searchName) || 
                searchName.includes(item.name.toLowerCase())) {
                return id;
            }
        }
        
        // 3. å°è¯•å…³é”®è¯åŒ¹é…ï¼ˆåªåŒ¹é…ä¸»è¦éƒ¨åˆ†ï¼‰
        const keywords = searchName.split(/[ã€ï¼Œ, ]+/);
        for (const id in state.customItems) {
            const item = state.customItems[id];
            const itemNameLower = item.name.toLowerCase();
            
            for (const keyword of keywords) {
                if (keyword.length > 1 && itemNameLower.includes(keyword)) {
                    return id;
                }
            }
        }
        
        // 4. å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå¯ç”¨çš„å®¶å…·
        const availableItems = Object.keys(state.inventory).filter(id => 
            state.inventory[id] > 0 && state.customItems[id]
        );
        
        if (availableItems.length > 0) {
            // å°è¯•è¿”å›ç±»å‹åŒ¹é…çš„å®¶å…·
            const typeMatch = availableItems.find(id => {
                const item = state.customItems[id];
                // å¦‚æœåç§°ä¸­åŒ…å«å®¶å…·ç±»å‹å…³é”®è¯
                if (searchName.includes('åºŠ') && item.name.includes('åºŠ')) return true;
                if (searchName.includes('æ¡Œ') && item.name.includes('æ¡Œ')) return true;
                if (searchName.includes('ç”»') && item.name.includes('ç”»')) return true;
                if (searchName.includes('åœ°æ¯¯') && item.name.includes('åœ°æ¯¯')) return true;
                if (searchName.includes('æ¤ç‰©') && item.name.includes('è‰')) return true;
                return false;
            });
            
            return typeMatch || availableItems[0];
        }
        
        return null;
    }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; 
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
    
    // === é¢œè‰²é€‰æ‹©åŠŸèƒ½ ===
    
    let currentColorTarget = null; // 'wall' æˆ– 'floor'
    let originalColor = null;
    
    // é¢„è®¾é¢œè‰²æ•°ç»„
    const presetColors = [
        '#f8c3cd', // ç²‰è‰²ï¼ˆå¢™é¢é»˜è®¤ï¼‰
        '#f5e6e8', // æµ…ç²‰è‰²ï¼ˆåœ°é¢é»˜è®¤ï¼‰
        '#fff3ad', // é»„è‰²
        '#aedeef', // è“è‰²
        '#c9e4c5', // ç»¿è‰²
        '#ffe0b2', // æ©™è‰²
        '#e8eaf6', // ç´«è‰²
        '#e0f2f1', // é’è‰²
        '#fce4ec', // æµ…çº¢
        '#f3e5f5', // æµ…ç´«
        '#fff8e1', // æµ…é»„
        '#e1f5fe', // æµ…è“
        '#f1f8e9', // æµ…ç»¿
        '#efebe9', // æµ…ç°
        '#fffde7', // ç±³ç™½
        '#fafafa'  // çº¯ç™½
    ];
    
    // åˆå§‹åŒ–é¢œè‰²é€‰æ‹©å™¨
    function initColorPicker() {
        const presetContainer = document.getElementById('preset-colors');
        presetContainer.innerHTML = '';
        
        // æ·»åŠ é¢„è®¾é¢œè‰²
        presetColors.forEach(color => {
            const colorBtn = document.createElement('div');
            colorBtn.style.width = '24px';
            colorBtn.style.height = '24px';
            colorBtn.style.backgroundColor = color;
            colorBtn.style.border = '2px solid var(--dark-pink)';
            colorBtn.style.borderRadius = '4px';
            colorBtn.style.cursor = 'pointer';
            colorBtn.style.transition = 'transform 0.2s ease';
            colorBtn.style.margin = '2px';
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            colorBtn.onclick = () => {
                document.getElementById('color-input').value = color;
                document.getElementById('color-picker').value = color;
            };
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            colorBtn.onmouseover = () => {
                colorBtn.style.transform = 'scale(1.1)';
            };
            
            colorBtn.onmouseout = () => {
                colorBtn.style.transform = 'scale(1)';
            };
            
            presetContainer.appendChild(colorBtn);
        });
    }
    
    // === å®¶å…·æ“ä½œåŠŸèƒ½ ===
    let selectedFurnitureIndex = null;
    let tempFurnitureSize = { width: 1, height: 1 };
    let tempFurnitureRotation = 0;
    
    // æ‰“å¼€å®¶å…·æ“ä½œå¼¹çª—
    function openFurnitureControl() {
        const modal = document.getElementById('furniture-control-modal');
        const display = document.getElementById('selected-furniture-display');
        const preview = document.getElementById('furniture-preview');
        const sizeDisplay = document.getElementById('furniture-size-display');
        const rotationDisplay = document.getElementById('rotation-display');
        
        // å¦‚æœæ²¡æœ‰é€‰ä¸­å®¶å…·ï¼Œæ˜¾ç¤ºæç¤º
        if (selectedFurnitureIndex === null || !state.placedItems[selectedFurnitureIndex]) {
            display.innerHTML = `<div style="font-size: 12px; margin-bottom: 10px;">è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€ä¸ªå®¶å…·</div>`;
            sizeDisplay.textContent = '1 x 1';
            rotationDisplay.textContent = '0Â°';
            preview.innerHTML = '';
            modal.style.display = 'flex';
            return;
        }
        
        const pItem = state.placedItems[selectedFurnitureIndex];
        const item = state.customItems[pItem.itemId];
        
        // æ›´æ–°æ˜¾ç¤º
        display.innerHTML = `<div style="font-size: 12px; margin-bottom: 10px;">${item.name}</div>`;
        
        // é‡ç½®ä¸´æ—¶å˜é‡
        tempFurnitureSize = { width: pItem.width || 1, height: pItem.height || 1 };
        tempFurnitureRotation = pItem.rotation || 0;
        
        // æ›´æ–°é¢„è§ˆ
        preview.innerHTML = item.svg;
        preview.style.width = `${tempFurnitureSize.width * 32}px`;
        preview.style.height = `${tempFurnitureSize.height * 32}px`;
        preview.style.transform = `rotate(${tempFurnitureRotation}deg)`;
        
        // æ›´æ–°æ˜¾ç¤º
        sizeDisplay.textContent = `${tempFurnitureSize.width} x ${tempFurnitureSize.height}`;
        rotationDisplay.textContent = `${tempFurnitureRotation}Â°`;
        
        modal.style.display = 'flex';
    }
    
    // å…³é—­å®¶å…·æ“ä½œå¼¹çª—
    function closeFurnitureControl() {
        const modal = document.getElementById('furniture-control-modal');
        modal.style.display = 'none';
        selectedFurnitureIndex = null;
    }
    
    // ç¼©æ”¾å®¶å…·
    function scaleFurniture(widthDelta, heightDelta) {
        // æ›´æ–°ä¸´æ—¶å¤§å°
        tempFurnitureSize.width = Math.max(1, tempFurnitureSize.width + widthDelta);
        tempFurnitureSize.height = Math.max(1, tempFurnitureSize.height + heightDelta);
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('furniture-size-display').textContent = `${tempFurnitureSize.width} x ${tempFurnitureSize.height}`;
        
        // æ›´æ–°é¢„è§ˆ
        const preview = document.getElementById('furniture-preview');
        preview.style.width = `${tempFurnitureSize.width * 32}px`;
        preview.style.height = `${tempFurnitureSize.height * 32}px`;
    }
    
    // æ—‹è½¬å®¶å…·
    function rotateFurniture(degrees) {
        // æ›´æ–°ä¸´æ—¶æ—‹è½¬è§’åº¦ï¼Œç¡®ä¿åœ¨0-360ä¹‹é—´
        tempFurnitureRotation = (tempFurnitureRotation + degrees + 360) % 360;
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('rotation-display').textContent = `${tempFurnitureRotation}Â°`;
        
        // æ›´æ–°é¢„è§ˆ
        const preview = document.getElementById('furniture-preview');
        preview.style.transform = `rotate(${tempFurnitureRotation}deg)`;
    }
    
    // é‡ç½®å®¶å…·å¤§å°
    function resetFurnitureSize() {
        // é‡ç½®ä¸º1x1
        tempFurnitureSize = { width: 1, height: 1 };
        document.getElementById('furniture-size-display').textContent = '1 x 1';
        
        // æ›´æ–°é¢„è§ˆ
        const preview = document.getElementById('furniture-preview');
        preview.style.width = '32px';
        preview.style.height = '32px';
    }
    
    // åº”ç”¨å®¶å…·æ›´æ”¹
    function applyFurnitureChanges() {
        if (selectedFurnitureIndex === null || !state.placedItems[selectedFurnitureIndex]) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¶å…·');
            return;
        }
        
        const pItem = state.placedItems[selectedFurnitureIndex];
        
        // æ›´æ–°å®¶å…·çŠ¶æ€
        pItem.width = tempFurnitureSize.width;
        pItem.height = tempFurnitureSize.height;
        pItem.rotation = tempFurnitureRotation;
        
        // æ›´æ–°UI
        updateUI();
        saveData();
        
        showToast('å®¶å…·å·²æ›´æ–°');
        closeFurnitureControl();
    }
    
    // å›æ”¶å®¶å…·
    function recycleFurniture() {
        if (selectedFurnitureIndex === null || !state.placedItems[selectedFurnitureIndex]) {
            showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¶å…·');
            return;
        }
        
        const pItem = state.placedItems[selectedFurnitureIndex];
        
        // å°†å®¶å…·æ”¾å›åº“å­˜
        if (state.inventory[pItem.itemId]) {
            state.inventory[pItem.itemId]++;
        } else {
            state.inventory[pItem.itemId] = 1;
        }
        
        // ä»å·²æ”¾ç½®åˆ—è¡¨ä¸­ç§»é™¤
        state.placedItems.splice(selectedFurnitureIndex, 1);
        
        // æ›´æ–°å ç”¨ç½‘æ ¼
        updateOccupiedGrid();
        
        // ä¿å­˜æ•°æ®å¹¶æ›´æ–°UI
        saveData();
        updateUI();
        
        showToast('å®¶å…·å·²å›æ”¶');
        closeFurnitureControl();
    }
    
    // æ‰“å¼€é¢œè‰²é€‰æ‹©å™¨
    function openColorPicker(type) {
        currentColorTarget = type;
        const modal = document.getElementById('color-picker-modal');
        const title = document.getElementById('color-modal-title');
        const colorInput = document.getElementById('color-input');
        const colorPicker = document.getElementById('color-picker');
        
        // è®¾ç½®æ ‡é¢˜
        title.textContent = type === 'wall' ? 'ğŸ¨ ä¿®æ”¹å¢™é¢é¢œè‰²' : 'ğŸ¨ ä¿®æ”¹åœ°æ¿é¢œè‰²';
        
        // è·å–å½“å‰é¢œè‰²
        const targetElement = type === 'wall' ? document.getElementById('wall-area') : document.getElementById('floor-area');
        originalColor = getComputedStyle(targetElement).backgroundColor;
        
        // è½¬æ¢ä¸ºHEXæ ¼å¼
        const hexColor = rgbToHex(originalColor);
        colorInput.value = hexColor;
        colorPicker.value = hexColor;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'flex';
    }
    
    // å…³é—­é¢œè‰²é€‰æ‹©å™¨
    function closeColorPicker() {
        const modal = document.getElementById('color-picker-modal');
        modal.style.display = 'none';
        currentColorTarget = null;
    }
    
    // é‡ç½®é¢œè‰²
    function resetColor() {
        const defaultWallColor = '#f8c3cd';
        const defaultFloorColor = '#f5e6e8';
        
        let defaultColor = defaultWallColor;
        if (currentColorTarget === 'floor') {
            defaultColor = defaultFloorColor;
        }
        
        document.getElementById('color-input').value = defaultColor;
        document.getElementById('color-picker').value = defaultColor;
        
        // é‡ç½®æ ·å¼é€‰æ‹©ä¸ºçº¯è‰²
        const solidOption = document.querySelector('input[name="style-option"][value="solid"]');
        if (solidOption) {
            solidOption.checked = true;
        }
    }
    
    // åº”ç”¨é¢œè‰²
    function applyColor() {
        if (!currentColorTarget) return;
        
        const colorInput = document.getElementById('color-input');
        let color = colorInput.value;
        
        // éªŒè¯é¢œè‰²æ ¼å¼
        if (!isValidHex(color)) {
            showToast('é¢œè‰²æ ¼å¼ä¸æ­£ç¡®');
            return;
        }
        
        // è·å–é€‰æ‹©çš„æ ·å¼
        const selectedStyle = document.querySelector('input[name="style-option"]:checked').value;
        
        // åº”ç”¨é¢œè‰²å’Œæ ·å¼
        const targetElement = currentColorTarget === 'wall' ? document.getElementById('wall-area') : document.getElementById('floor-area');
        targetElement.style.backgroundColor = color;
        
        // æ ¹æ®é€‰æ‹©çš„æ ·å¼åº”ç”¨ä¸åŒçš„èƒŒæ™¯æ ·å¼
        if (selectedStyle === 'solid') {
            targetElement.style.backgroundImage = 'none';
            targetElement.style.backgroundSize = 'auto';
            targetElement.style.backgroundPosition = '0 0';
        } else if (selectedStyle === 'pattern1') {
            if (currentColorTarget === 'wall') {
                targetElement.style.backgroundImage = `
                    linear-gradient(45deg, var(--dark-pink) 25%, transparent 25%, transparent 75%, var(--dark-pink) 75%, var(--dark-pink)),
                    linear-gradient(45deg, var(--dark-pink) 25%, transparent 25%, transparent 75%, var(--dark-pink) 75%, var(--dark-pink))
                `;
                targetElement.style.backgroundSize = '16px 16px';
                targetElement.style.backgroundPosition = '0 0, 8px 8px';
            } else {
                // åœ°é¢èŠ±çº¹1ï¼šå°æ–¹å—
                targetElement.style.backgroundImage = `
                    linear-gradient(90deg, transparent 25%, rgba(0,0,0,0.1) 25%, rgba(0,0,0,0.1) 50%, transparent 50%, transparent 75%, rgba(0,0,0,0.1) 75%),
                    linear-gradient(rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%)
                `;
                targetElement.style.backgroundSize = '32px 32px';
                targetElement.style.backgroundPosition = '0 0';
            }
        } else if (selectedStyle === 'pattern2') {
            if (currentColorTarget === 'wall') {
                // å¢™é¢èŠ±çº¹2ï¼šç«–æ¡çº¹
                targetElement.style.backgroundImage = `
                    linear-gradient(90deg, var(--dark-pink) 10%, transparent 10%, transparent 90%, var(--dark-pink) 90%)
                `;
                targetElement.style.backgroundSize = '32px 100%';
                targetElement.style.backgroundPosition = '0 0';
            } else {
                // åœ°é¢èŠ±çº¹2ï¼šæ–œçº¿æ¡çº¹
                targetElement.style.backgroundImage = `
                    linear-gradient(45deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%, rgba(0,0,0,0.05)),
                    linear-gradient(135deg, rgba(0,0,0,0.05) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.05) 75%, rgba(0,0,0,0.05))
                `;
                targetElement.style.backgroundSize = '64px 64px';
                targetElement.style.backgroundPosition = '0 0, 32px 32px';
            }
        }
        
        // æ›´æ–°æŒ‰é’®èƒŒæ™¯è‰²
        if (currentColorTarget === 'wall') {
            const wallBtn = document.querySelector('button[onclick="openColorPicker(\'wall\')"]');
            wallBtn.style.background = color;
        } else {
            const floorBtn = document.querySelector('button[onclick="openColorPicker(\'floor\')"]');
            floorBtn.style.background = color;
        }
        
        showToast('é¢œè‰²å’Œæ ·å¼å·²æ›´æ–°');
        closeColorPicker();
    }
    
    // RGBè½¬HEX
    function rgbToHex(rgb) {
        // ä»rgb(r, g, b)æ ¼å¼ä¸­æå–æ•°å­—
        const rgbMatch = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (!rgbMatch) return '#ffffff';
        
        const r = parseInt(rgbMatch[1]);
        const g = parseInt(rgbMatch[2]);
        const b = parseInt(rgbMatch[3]);
        
        // è½¬æ¢ä¸ºHEX
        const hex = ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        return '#' + hex;
    }
    
    // éªŒè¯HEXé¢œè‰²æ ¼å¼
    function isValidHex(color) {
        return /^#[0-9A-Fa-f]{6}$/.test(color);
    }
    
    // å½“é¢œè‰²è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
    document.addEventListener('DOMContentLoaded', () => {
        initColorPicker();
        
        const colorInput = document.getElementById('color-input');
        const colorPicker = document.getElementById('color-picker');
        
        // è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
        colorInput.addEventListener('input', () => {
            if (isValidHex(colorInput.value)) {
                colorPicker.value = colorInput.value;
            }
        });
        
        // é¢œè‰²é€‰æ‹©å™¨å˜åŒ–æ—¶æ›´æ–°è¾“å…¥æ¡†
        colorPicker.addEventListener('input', () => {
            colorInput.value = colorPicker.value;
        });
    });
    
    // === APIç›¸å…³å‡½æ•° ===
    
    async function fetchModels() {
        const url = document.getElementById('api-url-input').value.trim();
        const key = document.getElementById('api-key-input').value.trim();
        const logEl = document.getElementById('api-test-log');
        const modelListEl = document.getElementById('model-list');
        const modelCountEl = document.getElementById('model-count');
        
        if (!url || !key) {
            logEl.textContent = "é”™è¯¯ï¼šåœ°å€å’Œå¯†é’¥ä¸èƒ½ä¸ºç©º";
            return;
        }
        
        logEl.textContent = "æ­£åœ¨æ‹‰å–æ‰€æœ‰æ¨¡å‹...";
        modelListEl.innerHTML = '<div class="model-item" style="text-align:center;">åŠ è½½ä¸­...</div>';
        modelCountEl.textContent = "0";
        
        try {
            const response = await fetch(`${url}/models`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${key}`,
                    'Accept': '*/*'
                },
                mode: 'cors'
            });

            if (!response.ok) {
                const errData = await response.text().catch(() => 'æ— è¯¦æƒ…');
                throw new Error(`æ¥å£é”™è¯¯ ${response.status}: ${errData}`);
            }

            const data = await response.json();
            const allModels = data.data.map(model => model.id).sort();

            if (allModels.length === 0) {
                logEl.textContent = "è­¦å‘Šï¼šæœªæ‰¾åˆ°ä»»ä½•å¯ç”¨æ¨¡å‹";
                modelListEl.innerHTML = '<div class="model-item" style="text-align:center;">æ— å¯ç”¨æ¨¡å‹</div>';
                modelCountEl.textContent = "0";
                return;
            }

            state.availableModels = allModels;
            state.filteredModels = [...allModels];
            logEl.textContent = `âœ… æˆåŠŸæ‹‰å– ${allModels.length} ä¸ªæ¨¡å‹`;
            logEl.style.color = "#2ecc71";
            modelCountEl.textContent = allModels.length;
            renderModelList();
        } catch (e) {
            console.error("æ‹‰å–æ¨¡å‹é”™è¯¯:", e);
            logEl.textContent = `âŒ æ‹‰å–å¤±è´¥ï¼š${e.message.slice(0, 50)}`;
            modelListEl.innerHTML = '<div class="model-item" style="text-align:center; color:#e74c3c;">æ‹‰å–å¤±è´¥</div>';
            modelCountEl.textContent = "0";
        }
    }
    
    function filterModels(type) {
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.filter-btn[onclick="filterModels('${type}')"]`).classList.add('active');
        
        switch(type) {
            case 'all':
                state.filteredModels = [...state.availableModels];
                break;
            case 'llm':
                state.filteredModels = state.availableModels.filter(model => 
                    /gpt|deepseek|qwen|llama|chat|claude|ernie|glm/i.test(model)
                );
                break;
            case 'vision':
                state.filteredModels = state.availableModels.filter(model => 
                    /vision|vl|image|pix/i.test(model)
                );
                break;
            case 'other':
                state.filteredModels = state.availableModels.filter(model => 
                    !/gpt|deepseek|qwen|llama|chat|claude|ernie|glm|vision|vl|image|pix/i.test(model)
                );
                break;
        }
        
        document.getElementById('model-count').textContent = state.filteredModels.length;
        renderModelList();
    }
    
    function renderModelList() {
        const modelListEl = document.getElementById('model-list');
        const selectedModel = document.getElementById('selected-model').value;
        
        if (state.filteredModels.length === 0) {
            modelListEl.innerHTML = '<div class="model-item" style="text-align:center;">æ— åŒ¹é…æ¨¡å‹</div>';
            return;
        }

        modelListEl.innerHTML = '';
        state.filteredModels.forEach(model => {
            const div = document.createElement('div');
            div.className = `model-item ${model === selectedModel ? 'selected' : ''}`;
            div.textContent = model;
            div.title = model;
            div.onclick = () => {
                document.getElementById('selected-model').value = model;
                renderModelList();
            };
            modelListEl.appendChild(div);
        });
    }
    
    async function testAPI() {
        const url = document.getElementById('api-url-input').value.trim();
        const key = document.getElementById('api-key-input').value.trim();
        const model = document.getElementById('selected-model').value;
        const logEl = document.getElementById('api-test-log');
        
        if (!url || !key) {
            logEl.textContent = "é”™è¯¯ï¼šåœ°å€å’Œå¯†é’¥ä¸èƒ½ä¸ºç©º";
            return;
        }
        if (!model) {
            logEl.textContent = "é”™è¯¯ï¼šè¯·å…ˆé€‰æ‹©æ¨¡å‹";
            return;
        }
        
        logEl.textContent = "æµ‹è¯•è¿æ¥ä¸­...";
        try {
            const response = await fetch(`${url}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: "user", content: "è¿”å›1ä¸ªæ±‰å­—" }],
                    max_tokens: 1
                }),
                mode: 'cors'
            });
            
            if (response.ok) {
                logEl.textContent = "âœ… è¿æ¥æˆåŠŸï¼å¯æ­£å¸¸ä½¿ç”¨";
                logEl.style.color = "#2ecc71";
            } else {
                const err = await response.text().catch(() => 'æœªçŸ¥é”™è¯¯');
                logEl.textContent = `âŒ å¤±è´¥ï¼š${response.status} - ${err.slice(0, 50)}`;
            }
        } catch (e) {
            logEl.textContent = `âŒ è¿æ¥å¤±è´¥ï¼š${e.message.slice(0, 50)}`;
        }
    }
    
    function saveSettings() {
        state.apiKey = document.getElementById('api-key-input').value.trim();
        state.apiUrl = document.getElementById('api-url-input').value.trim();
        state.apiModel = document.getElementById('selected-model').value.trim();
        saveData();
        closeSettings();
        showToast("API è®¾ç½®å·²ä¿å­˜");
    }
    
    function openSettings() { 
        document.getElementById('settings-modal').style.display = 'flex'; 
    }
    
    function closeSettings() { 
        document.getElementById('settings-modal').style.display = 'none'; 
    }
    
    // === åˆå§‹åŒ– ===
    
function init() {
        const saved = localStorage.getItem('aiPixelGacha_v8');
        if (saved) {
            const parsed = JSON.parse(saved);
            state = { ...state, ...parsed };
            
            fixItemProperties();
            
            if (!state.apiUrl) state.apiUrl = "https://api.openai.com/v1";
            
            // ç¡®ä¿charactersæ•°ç»„å­˜åœ¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
            if (!state.characters) {
                state.characters = [];
            }
            
            initializeCatalog();
            updateOccupiedGrid();
        } else {
            state.customItems = { ...DEFAULT_FURNITURE };
            state.inventory['bed_01'] = 1;
            state.inventory['plant_01'] = 2;
            state.inventory['painting_01'] = 1;
            state.characters = []; // åˆå§‹åŒ–ç©ºè§’è‰²æ•°ç»„
            initializeCatalog();
            updateOccupiedGrid();
        }
        
        document.getElementById('api-url-input').value = state.apiUrl;
        document.getElementById('api-key-input').value = state.apiKey;
        document.getElementById('selected-model').value = state.apiModel || "";
        
        state.filteredModels = [...state.availableModels];
        renderModelList();
        updateUI();
        
        setInterval(() => {
            if (state.coins < 200) {
                state.coins += 5;
                saveData();
                updateUI();
            }
        }, 10000);
        
        initDragEvents();
    }
    
    function fixItemProperties() {
        Object.keys(state.customItems).forEach(key => {
            const item = state.customItems[key];
            
            if (!item.type) {
                if (item.name.includes('åºŠ') || item.name.includes('æ¡Œ') || item.name.includes('æŸœ')) {
                    item.type = ITEM_TYPES.FURNITURE;
                } else if (item.name.includes('ç”»') || item.name.includes('çª—')) {
                    item.type = ITEM_TYPES.WALL;
                } else if (item.name.includes('åœ°æ¯¯') || item.name.includes('å«')) {
                    item.type = ITEM_TYPES.FLOOR;
                } else {
                    item.type = ITEM_TYPES.DECOR;
                }
            }
            
            if (!item.width) item.width = 1;
            if (!item.height) item.height = 1;
            
            if (item.inPool === undefined) item.inPool = true;
        });
    }
    
    function initializeCatalog() {
        Object.keys(state.customItems).forEach(itemId => {
            if (!state.catalog[itemId]) {
                state.catalog[itemId] = {
                    seen: false,
                    owned: false
                };
            }
        });
        
        updateCatalogOwnership();
    }
    
    function updateCatalogOwnership() {
        Object.keys(state.catalog).forEach(itemId => {
            if (state.customItems[itemId]) {
                if (state.inventory[itemId] > 0 || state.placedItems.some(p => p.itemId === itemId)) {
                    state.catalog[itemId].seen = true;
                    state.catalog[itemId].owned = true;
                } else {
                    state.catalog[itemId].owned = false;
                }
            }
        });
    }
    
    function initDragEvents() {
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('touchmove', handleDrag, { passive: false });
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }
    
    window.addEventListener('DOMContentLoaded', init);
</script>
<style>
    @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</body>
</html>